name: Integration Tests

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      RUST_BACKTRACE: full
      RUST_LOG: debug

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev protobuf-compiler

      - name: Cache Cargo registry + build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            target
          key: ${{ runner.os }}-cargo-export-modules-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build module for l402
        run: |
          cargo build --release --features export-modules

      - name: Set up Docker Compose
        env:
          ROOT_KEY: ${{ secrets.ROOT_KEY }}
          CURRENCY: USD
          AMOUNT: 0.01
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.5.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose -f docker-compose.yml up -d bitcoind

      - name: Create env file
        run: |
          touch .env
          echo ROOT_KEY=${{ secrets.ROOT_KEY }} >> .env
          echo CASHU_WALLET_SECRET=test_cashu_wallet_secret >> .env
          cat .env

      - name: Start LNURL service
        env:
          LNURL_ADDRESS: ${{ secrets.LNURL_ADDRESS }}
        run: |
          docker-compose -f docker-compose.yml up -d nginx-lnurl grpc-content-server

      - name: Run Integration Tests - LNURL
        run: |
          docker logs nginx-lnurl
          echo "Testing with LNURL configuration..."
          sleep 15

          # Test free route
          echo "Testing free route..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Free route returned status $status_code, expected 200"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test protected route without header
          echo "Testing protected route without header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route without header returned status $status_code, expected 402"
            docker logs nginx-lnurl
            exit 1
          fi

          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test with valid L402 credentials
          echo "Testing with valid L402 credentials..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:e582fba50ca50a9a262cbb92fc38617ce0a2413ef1dd4c7062cbaef22b33a404" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with valid L402 returned status $status_code, expected 200"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test with invalid preimage
          echo "Testing with invalid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:fbe9ac25c04e14b10177514e2d57b0e39224e70277ac1a2cd23c28e58cd4ea35" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid preimage returned status $status_code, expected 401"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test with macaroon without caveats
          echo "Testing with macaroon without caveats..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 AgEETFNBVALmAUr/gQMBARJNYWNhcm9vbklkZW50aWZpZXIB/4IAAQMBB1ZlcnNpb24BBgABC1BheW1lbnRIYXNoAf+EAAEHVG9rZW5JZAH/hgAAABT/gwEBAQRIYXNoAf+EAAEGAUAAABn/hQEBAQlbMzJddWludDgB/4YAAQYBQAAAa/+CAiD/pv/jOjY1/9oC/4z/tHb/qf/2Jf+d/4H/u/+YGHj/+/+O/8D/v/+P/8X/qRL/5v/x/4r/tkIBIA1Y/8j/pR3/0P+b/7cwWP+W/87/sD18GP//Hf/f/9Aj//NcBFs2/9VhNEUF/70AAAAGIDlR1jVm5IfEJgvuSQoJLqLg4FcW4Ib1vW8sbkRHdUWX:651505fae9ea341c770c6ebef207d8560d546eb3aee26985e584c15d1c987875" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with macaroon without caveats returned status $status_code, expected 401"
            docker logs nginx-lnurl
            exit 1
          fi

      - name: Run Integration Tests - gRPC
        run: |
          docker logs grpc-content-server
          echo "Testing gRPC server..."
          sleep 5

          # Install grpcurl for testing gRPC endpoints
          echo "Installing grpcurl..."
          curl -L https://github.com/fullstorydev/grpcurl/releases/download/v1.8.9/grpcurl_1.8.9_linux_x86_64.tar.gz | tar -xzf - -C /tmp
          sudo mv /tmp/grpcurl /usr/local/bin/

          # Test gRPC service reflection
          echo "Testing gRPC service reflection..."
          grpcurl -plaintext localhost:50051 list || {
            echo "Error: gRPC reflection failed"
            docker logs grpc-content-server
            exit 1
          }

          # Test GetContent method
          echo "Testing GetContent method..."
          response=$(grpcurl -plaintext -d '{"path": "/test.txt"}' localhost:50051 content.ContentService/GetContent)
          if ! echo "$response" | grep -q "Content for path"; then
            echo "Error: GetContent method failed"
            echo "Response: $response"
            docker logs grpc-content-server
            exit 1
          fi

          # Test GetProtectedContent method
          echo "Testing GetProtectedContent method..."
          response=$(grpcurl -plaintext -d '{"path": "/protected"}' localhost:50051 content.ContentService/GetProtectedContent)
          if ! echo "$response" | grep -q "This is Protected Content"; then
            echo "Error: GetProtectedContent method failed"
            echo "Response: $response"
            docker logs grpc-content-server
            exit 1
          fi

          # Test GetFreeContent method
          echo "Testing GetFreeContent method..."
          response=$(grpcurl -plaintext -d '{"path": "/free"}' localhost:50051 content.ContentService/GetFreeContent)
          if ! echo "$response" | grep -q "Free Content"; then
            echo "Error: GetFreeContent method failed"
            echo "Response: $response"
            docker logs grpc-content-server
            exit 1
          fi

          # Test gRPC through nginx proxy (L402 protected)
          echo "Testing gRPC through nginx proxy with L402 protection..."
          
          # First test without L402 header - should get 402
          echo "Testing gRPC endpoint without L402 header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -H "Content-Type: application/grpc" -H "grpc-timeout: 60S" -X POST http://0.0.0.0:8000/content.ContentService/GetProtectedContent)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: gRPC endpoint without L402 returned status $status_code, expected 402"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi
          
          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response for gRPC"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test with valid L402 credentials for gRPC
          echo "Testing gRPC endpoint with valid L402 credentials..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -H "Content-Type: application/grpc" -H "grpc-timeout: 60S" -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:e582fba50ca50a9a262cbb92fc38617ce0a2413ef1dd4c7062cbaef22b33a404" -X POST http://0.0.0.0:8000/content.ContentService/GetProtectedContent)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: gRPC endpoint with valid L402 returned status $status_code, expected 200"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi

          echo "All gRPC tests completed successfully!"

      - name: Stop LNURL service
        run: |
          docker-compose -f docker-compose.yml stop nginx-lnurl

      - name: Start cln, cashu-mint, lndnode, lndnode-receiver and bitcoin-setup
        run: |
          docker-compose -f docker-compose.yml up -d --no-deps cln cashu-mint lndnode lndnode-receiver bitcoin-setup

          max_wait=150
          elapsed=0
          while [ $elapsed -lt $max_wait ]; do
            if docker logs bitcoin-setup 2>&1 | grep -q "✅ Bitcoin/LND/Cashu setup completed successfully!"; then
              echo "Bitcoin setup completed successfully!"
              break
            fi
            echo "Waiting for setup... (${elapsed}s/${max_wait}s)"
            sleep 10
            elapsed=$((elapsed + 10))
          done
          
          if [ $elapsed -ge $max_wait ]; then
            echo "⚠️ Setup timeout - checking logs..."
            docker logs bitcoin-setup
            exit 1
          fi
          
          # Verify Cashu wallet has balance
          CASHU_BALANCE=$(docker exec cashu-mint poetry run cashu balance 2>&1 | grep -oP 'Balance: \K\d+' || echo "0")
          echo "Current Cashu balance: $CASHU_BALANCE sat"

      - name: Start CLN service
        run: |
          docker-compose -f docker-compose.yml up -d --no-deps nginx-cln

      - name: Run Integration Tests - CLN
        run: |
          docker logs cln
          docker logs nginx-cln
          echo "Testing with CLN configuration..."
          sleep 15

          docker exec nginx-cln chmod 777 /root /root/.lightning /root/.lightning/regtest

          # Test free route
          echo "Testing free route..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Free route returned status $status_code, expected 200"
            docker logs nginx-cln
            exit 1
          fi

          # Test with valid L402 credentials
          echo "Testing with valid L402 credentials..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:e582fba50ca50a9a262cbb92fc38617ce0a2413ef1dd4c7062cbaef22b33a404" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with valid L402 returned status $status_code, expected 200"
            docker logs nginx-cln
            exit 1
          fi

          # Test with invalid preimage
          echo "Testing with invalid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:fbe9ac25c04e14b10177514e2d57b0e39224e70277ac1a2cd23c28e58cd4ea35" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid preimage returned status $status_code, expected 401"
            docker logs nginx-cln
            exit 1
          fi

          # Test with macaroon without caveats
          echo "Testing with macaroon without caveats..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 AgEETFNBVALmAUr/gQMBARJNYWNhcm9vbklkZW50aWZpZXIB/4IAAQMBB1ZlcnNpb24BBgABC1BheW1lbnRIYXNoAf+EAAEHVG9rZW5JZAH/hgAAABT/gwEBAQRIYXNoAf+EAAEGAUAAABn/hQEBAQlbMzJddWludDgB/4YAAQYBQAAAa/+CAiD/pv/jOjY1/9oC/4z/tHb/qf/2Jf+d/4H/u/+YGHj/+/+O/8D/v/+P/8X/qRL/5v/x/4r/tkIBIA1Y/8j/pR3/0P+b/7cwWP+W/87/sD18GP//Hf/f/9Aj//NcBFs2/9VhNEUF/70AAAAGIDlR1jVm5IfEJgvuSQoJLqLg4FcW4Ib1vW8sbkRHdUWX:651505fae9ea341c770c6ebef207d8560d546eb3aee26985e584c15d1c987875" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with macaroon without caveats returned status $status_code, expected 401"
            docker logs nginx-cln
            exit 1
          fi

          # Test protected route without header
          echo "Testing protected route without header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 60 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route without header returned status $status_code, expected 402"
            docker logs nginx-cln
            exit 1
          fi
          
          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response"
            echo "$response"
            docker logs nginx-cln
            exit 1
          fi

      - name: Stop CLN service
        run: |
          docker-compose -f docker-compose.yml stop nginx-cln

      - name: Verify LND node
        run: |
          identity_pubkey_lndnode=$(docker exec lndnode lncli -n regtest getinfo | jq -r '.identity_pubkey')
          echo "Pubkey: $identity_pubkey_lndnode"
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -generate 5
          docker logs lndnode
          docker logs cln

          # Get node info for both lightning nodes
          echo "Getting CLN node info..."
          cln_pubkey=$(docker exec cln lightning-cli --network=regtest getinfo | jq -r '.id')
          echo "CLN pubkey: $cln_pubkey"

          echo "Getting LND node info..."
          lnd_pubkey=$(docker exec lndnode lncli -n regtest getinfo | jq -r '.identity_pubkey')
          echo "LND pubkey: $lnd_pubkey"

          # Generate a new address for LND node
          address=$(docker exec lndnode lncli -n regtest newaddress p2wkh | jq -r '.address')
          echo "Generated address for LND: $address"

          # Send 10 BTC to LND node from default wallet
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=default sendtoaddress "$address" 10
          
          # Generate blocks to confirm the transaction
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=default generatetoaddress 6 "$address"

          # Connect nodes
          echo "Connecting LND to CLN..."
          docker exec lndnode lncli -n regtest connect $cln_pubkey@cln:9835

          # Open channel from LND to CLN
          echo "Opening channel from LND to CLN..."
          docker exec lndnode lncli -n regtest openchannel $cln_pubkey 1000000

          # Generate blocks to confirm channel
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=default generatetoaddress 6 "$address"

          docker logs cln
          echo "NWC_URI=$(docker exec cln lightning-cli --network=regtest nip47-create label=nwc-for-l402 budget_msat=0 | jq -r '.uri')" >> $GITHUB_ENV

      - name: Start NWC service
        run: |
          docker-compose -f docker-compose.yml up -d --no-deps nginx-nwc

      - name: Run Integration Tests - NWC
        run: |
          docker logs nginx-nwc
          echo "Testing with NWC configuration..."
          sleep 20

          # Test free route
          echo "Testing free route..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Free route returned status $status_code, expected 200"
            docker logs nginx-nwc
            exit 1
          fi

          # Test protected route with timeout without header
          echo "Testing protected route with timeout without header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 60 -L http://0.0.0.0:8000/protected-timeout)
          status_code=$(echo "$response" | tail -n1)
          echo "status_code: $status_code"
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route without header returned status $status_code, expected 402"
            docker logs nginx-nwc
            exit 1
          fi
          
          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response"
            echo "$response"
            docker logs nginx-nwc
            exit 1
          fi

          # Extract invoice from header
          invoice=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'invoice="[^"]*"' | cut -d'"' -f2)
          if [ -z "$invoice" ]; then
            echo "Error: No invoice found in WWW-Authenticate header"
            echo "$response"
            docker logs nginx-nwc
            exit 1
          fi
          echo "invoice: $invoice"

          # Pay invoice using LND to get preimage
          echo "Paying invoice through LND..."
          docker logs lndnode
          payment_result=$(docker exec lndnode lncli -n regtest payinvoice -f $invoice 2>&1)
          docker logs lndnode
          echo "payment_result: $payment_result"
          
          # Wait a few seconds for payment to settle
          echo "Waiting for payment to settle..."
          sleep 5
          
          # Get payment result with preimage
          payment_result=$(docker exec lndnode lncli -n regtest listpayments | jq -r '.payments[-1]')
          payment_status=$(echo "$payment_result" | jq -r '.status')
          echo "payment_result: $payment_result"
          echo "payment_status: $payment_status"
          
          if [ "$payment_status" != "SUCCEEDED" ]; then
            echo "Error: Payment failed or timed out"
            docker logs nginx-nwc
            exit 1
          fi

          # Extract preimage from payment result
          preimage=$(echo "$payment_result" | jq -r '.payment_preimage')
          macaroon=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'macaroon="[^"]*"' | cut -d'"' -f2)

          # Test with obtained preimage immediately
          echo "Testing protected route with valid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 $macaroon:$preimage" http://0.0.0.0:8000/protected-timeout)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with valid preimage returned status $status_code, expected 200"
            docker logs nginx-nwc
            exit 1
          fi

          # Wait for macaroon to expire (10 seconds)
          echo "Waiting for macaroon to expire..."
          sleep 15

          # Test with expired macaroon
          echo "Testing protected route with expired macaroon..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 $macaroon:$preimage" http://0.0.0.0:8000/protected-timeout)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with expired macaroon returned status $status_code, expected 401"
            docker logs nginx-nwc
            exit 1
          fi

          # Test with invalid preimage
          echo "Testing with invalid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:fbe9ac25c04e14b10177514e2d57b0e39224e70277ac1a2cd23c28e58cd4ea35" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid preimage returned status $status_code, expected 401"
            docker logs nginx-nwc
            exit 1
          fi

          # Test with macaroon without caveats
          echo "Testing with macaroon without caveats..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 AgEETFNBVALmAUr/gQMBARJNYWNhcm9vbklkZW50aWZpZXIB/4IAAQMBB1ZlcnNpb24BBgABC1BheW1lbnRIYXNoAf+EAAEHVG9rZW5JZAH/hgAAABT/gwEBAQRIYXNoAf+EAAEGAUAAABn/hQEBAQlbMzJddWludDgB/4YAAQYBQAAAa/+CAiD/pv/jOjY1/9oC/4z/tHb/qf/2Jf+d/4H/u/+YGHj/+/+O/8D/v/+P/8X/qRL/5v/x/4r/tkIBIA1Y/8j/pR3/0P+b/7cwWP+W/87/sD18GP//Hf/f/9Aj//NcBFs2/9VhNEUF/70AAAAGIDlR1jVm5IfEJgvuSQoJLqLg4FcW4Ib1vW8sbkRHdUWX:651505fae9ea341c770c6ebef207d8560d546eb3aee26985e584c15d1c987875" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with macaroon without caveats returned status $status_code, expected 401"
            docker logs nginx-nwc
            exit 1
          fi

      - name: Stop NWC service and CLN node
        run: |
          docker-compose -f docker-compose.yml stop nginx-nwc cln

      - name: Start nginx containers for LND
        env:
          CURRENCY: USD
          AMOUNT: 0.01
        run: |
          docker-compose -f docker-compose.yml up -d --no-deps nginx-lnd redis

      - name: Run Integration Tests - LND
        run: |
          docker ps -a
          docker logs nginx-lnd
          docker logs cashu-mint
          echo "Testing with LND configuration..."
          sleep 15

          # Test free route
          echo "Testing free route..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Free route returned status $status_code, expected 200"
            docker logs nginx-lnd
            exit 1
          fi

          # Test protected route without header
          echo "Testing protected route without header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route without header returned status $status_code, expected 402"
            docker logs nginx-lnd
            exit 1
          fi
          
          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Extract and verify invoice amount
          invoice=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'invoice="[^"]*"' | cut -d'"' -f2)
          if [ -z "$invoice" ]; then
            echo "Error: No invoice found in WWW-Authenticate header"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi

          # Decode invoice and check amount
          decoded_amount=$(docker exec lndnode lncli -n regtest decodepayreq "$invoice" | jq -r '.num_msat')
          if [ "$decoded_amount" != "10000" ]; then
            echo "Error: Invoice amount is $decoded_amount msat, expected 10000 msat"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Test dynamic pricing by setting a new price in Redis
          echo "Setting dynamic price to 15000 msat..."
          docker exec redis redis-cli set /protected 15000

          # Test protected route to get new invoice with dynamic price
          echo "Testing protected route with dynamic price..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route with dynamic price returned status $status_code, expected 402"
            # docker logs nginx-lnd
            exit 1
          fi

          # Extract and verify new invoice amount
          invoice=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'invoice="[^"]*"' | cut -d'"' -f2)
          if [ -z "$invoice" ]; then
            echo "Error: No invoice found in WWW-Authenticate header for dynamic price"
            echo "$response"
            # docker logs nginx-lnd
            exit 1
          fi

          # Decode invoice and check dynamic amount
          decoded_amount=$(docker exec lndnode lncli -n regtest decodepayreq "$invoice" | jq -r '.num_msat')
          if [ "$decoded_amount" != "15000" ]; then
            echo "Error: Dynamic invoice amount is $decoded_amount msat, expected 15000 msat"
            echo "$response"
            # docker logs nginx-lnd
            exit 1
          fi

          # Reset price back to default
          echo "Resetting price back to default..."
          docker exec redis redis-cli del /protected

          # Test protected route to verify reset price
          echo "Testing protected route with reset price..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route with reset price returned status $status_code, expected 402"
            docker logs nginx-lnd
            exit 1
          fi

          # Extract and verify reset invoice amount
          invoice=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'invoice="[^"]*"' | cut -d'"' -f2)
          if [ -z "$invoice" ]; then
            echo "Error: No invoice found in WWW-Authenticate header after reset"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Decode invoice and check reset amount
          decoded_amount=$(docker exec lndnode lncli -n regtest decodepayreq "$invoice" | jq -r '.num_msat')
          if [ "$decoded_amount" != "10000" ]; then
            echo "Error: Reset invoice amount is $decoded_amount msat, expected 10000 msat"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Test with valid L402 credentials
          echo "Testing with valid L402 credentials..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:e582fba50ca50a9a262cbb92fc38617ce0a2413ef1dd4c7062cbaef22b33a404" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with valid L402 returned status $status_code, expected 200"
            docker logs nginx-lnd
            exit 1
          fi

          # Test with invalid preimage
          echo "Testing with invalid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:fbe9ac25c04e14b10177514e2d57b0e39224e70277ac1a2cd23c28e58cd4ea35" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid preimage returned status $status_code, expected 401"
            docker logs nginx-lnd
            exit 1
          fi

          # Test with macaroon without caveats
          echo "Testing with macaroon without caveats..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 AgEETFNBVALmAUr/gQMBARJNYWNhcm9vbklkZW50aWZpZXIB/4IAAQMBB1ZlcnNpb24BBgABC1BheW1lbnRIYXNoAf+EAAEHVG9rZW5JZAH/hgAAABT/gwEBAQRIYXNoAf+EAAEGAUAAABn/hQEBAQlbMzJddWludDgB/4YAAQYBQAAAa/+CAiD/pv/jOjY1/9oC/4z/tHb/qf/2Jf+d/4H/u/+YGHj/+/+O/8D/v/+P/8X/qRL/5v/x/4r/tkIBIA1Y/8j/pR3/0P+b/7cwWP+W/87/sD18GP//Hf/f/9Aj//NcBFs2/9VhNEUF/70AAAAGIDlR1jVm5IfEJgvuSQoJLqLg4FcW4Ib1vW8sbkRHdUWX:651505fae9ea341c770c6ebef207d8560d546eb3aee26985e584c15d1c987875" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with macaroon without caveats returned status $status_code, expected 401"
            docker logs nginx-lnd
            exit 1
          fi

          # Test Cashu eCash support
          echo "Testing Cashu eCash support..."

          # Ensure the Cashu database has proper permissions
          echo "Setting up Cashu database permissions..."
          docker exec nginx-lnd chmod 770 /app/data
          docker exec nginx-lnd chmod 660 /app/data/cashu_tokens.db
          echo "Cashu database permissions set successfully"
          
          # Check mint logs
          docker logs cashu-mint
          
          # Execute cashu commands inside the mint container using poetry run
          echo "Executing cashu commands inside the mint container..."
          
          # Check wallet info
          echo "Checking wallet info..."
          docker exec cashu-mint poetry run cashu info
          
          # Check initial balance
          echo "Checking initial balance..."
          docker exec cashu-mint poetry run cashu balance
          
          # Check balance after minting
          echo "Checking balance after minting..."
          docker exec cashu-mint poetry run cashu balance
          
          # Get token from wallet
          echo "Retrieving token from wallet..."
          CASHU_TOKEN=$(docker exec cashu-mint poetry run cashu send 100)

          echo "Cashu token: $CASHU_TOKEN"

          sleep 5
          
          # Test protected route with Cashu token
          echo "Testing protected route with Cashu token..."
          max_retries=3
          retry_count=0
          status_code=0
          
          while [ $retry_count -lt $max_retries ] && [ "$status_code" -ne 200 ]; do
            echo "Attempt $(($retry_count + 1)) of $max_retries..."
            response=$(curl -v -s -i -w "\n%{http_code}" --max-time 60 -L -H "Authorization: Cashu $CASHU_TOKEN" http://0.0.0.0:8000/protected)
            status_code=$(echo "$response" | tail -n1)
            
            if [ "$status_code" -ne 200 ]; then
              if echo "$response" | grep -q "401 Unauthorized"; then
                echo "Pool connection timed out, retrying..."
                sleep 5
                retry_count=$((retry_count + 1))
              else
                break
              fi
            fi
          done
          
          # The token should be accepted if the verification logic is working
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with Cashu token returned unexpected status $status_code"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi
          
          # Test with invalid Cashu token (insufficient amount)
          echo "Testing with invalid Cashu token (insufficient amount)..."

          INVALID_CASHU_TOKEN=$(docker exec cashu-mint poetry run cashu send 1)

          sleep 5
          
          # Test with the invalid token
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $INVALID_CASHU_TOKEN" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          
          # This should fail verification due to insufficient amount
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid Cashu token returned status $status_code, expected 401"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi
          
          # Test with malformed Cashu token
          echo "Testing with malformed Cashu token..."
          
          # Create a malformed token
          MALFORMED_CASHU_TOKEN='{
            "token": [
              {
                "mint": "http://cashu-mint:3338",
                "proofs": []
              }
            ]
          }'
          
          # Encode the malformed token
          ENCODED_MALFORMED_TOKEN=$(echo -n "$MALFORMED_CASHU_TOKEN" | base64 -w 0)

          sleep 5
          
          # Test with the malformed token
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $ENCODED_MALFORMED_TOKEN" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          
          # This should fail verification due to empty proofs
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with malformed Cashu token returned status $status_code, expected 401"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi
          
          # Test whitelisted mints functionality
          echo "Testing whitelisted mints functionality..."
          
          # Test with token from non-whitelisted mint
          echo "Testing with token from non-whitelisted mint (https://nofees.testnut.cashu.space)..."
          
          # Create a token with a non-whitelisted mint URL
          NON_WHITELISTED_TOKEN='{
            "token": [
              {
                "mint": "https://nofees.testnut.cashu.space",
                "proofs": [
                  {
                    "id": "test-proof",
                    "amount": 10,
                    "secret": "test-secret",
                    "C": "test-commitment"
                  }
                ]
              }
            ]
          }'
          
          # Encode the non-whitelisted token
          ENCODED_NON_WHITELISTED_TOKEN=$(echo -n "$NON_WHITELISTED_TOKEN" | base64 -w 0)

          sleep 5
          
          # Test with the non-whitelisted token
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $ENCODED_NON_WHITELISTED_TOKEN" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          
          # This should fail verification due to non-whitelisted mint
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with non-whitelisted Cashu token returned status $status_code, expected 401"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi
          
          echo "✅ Non-whitelisted mint token (https://nofees.testnut.cashu.space) correctly rejected!"

          echo "All Cashu eCash tests completed successfully!"

      - name: Run Integration Tests - Cashu Redeem on Lightning
        run: |
          echo "Testing Cashu redeem on lightning feature..."

          if docker exec nginx-lnd env | grep -q "CASHU_REDEEM_ON_LIGHTNING=true"; then
            echo "✅ Cashu redeem on lightning is enabled"
          else
            echo "❌ Cashu redeem on lightning is not enabled"
            exit 1
          fi

          if docker exec nginx-lnd env | grep -q "CASHU_WHITELISTED_MINTS="; then
            echo "✅ Cashu whitelisted mints are configured"
          else
            echo "❌ Cashu whitelisted mints are not configured"
            exit 1
          fi

          CASHU_TOKEN=$(docker exec cashu-mint poetry run cashu send 50 --legacy)

          echo "Generated Cashu token: $CASHU_TOKEN"
          echo "using cashu token to access protected route..."

          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $CASHU_TOKEN" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)

          if [ "$status_code" = "200" ]; then
            echo "Cashu token used successfully"
          else
            echo "❌ Cashu token rejected (code: $status_code)"
            docker logs nginx-lnurl
            exit 1
          fi

          INITIAL_BALANCE=$(docker exec lndnode lncli -n regtest walletbalance | jq -r '.confirmed_balance')
          echo "Initial LND confirmed balance: $INITIAL_BALANCE sats"

          echo "Verifying tokens are stored in Cashu database..."
          if docker exec nginx-lnd test -f /app/data/cashu_tokens.db; then
            echo "✅ Cashu database exists and contains tokens"
          else
            echo "Cashu database not found"
            exit 1
          fi

          REDEMPTION_INTERVAL=$(docker exec nginx-lnd env | grep CASHU_REDEMPTION_INTERVAL_SECS | cut -d'=' -f2 || echo "not_set")
          echo "Cashu redemption interval is set to: ${REDEMPTION_INTERVAL} seconds"

          WAIT_TIME=$((REDEMPTION_INTERVAL + 15))
          echo "Waiting ${WAIT_TIME} seconds for redemption process to complete (${REDEMPTION_INTERVAL}s interval)..."

          sleep $WAIT_TIME

          FINAL_BALANCE=$(docker exec lndnode lncli -n regtest walletbalance | jq -r '.confirmed_balance')
          echo "Final LND confirmed balance: $FINAL_BALANCE sats"

          BALANCE_DIFFERENCE=$((FINAL_BALANCE - INITIAL_BALANCE))
          echo "Balance difference: $BALANCE_DIFFERENCE sats"

          if [ "$BALANCE_DIFFERENCE" -gt 0 ]; then
            echo "✅ LND received payments from Cashu token redemption ($BALANCE_DIFFERENCE sats)"
          else
            echo "No redemption activity"
            exit 1
          fi

          echo "✅ Cashu redeem on lightning integration tests completed!"

      - name: Publish .so file
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          tar -czf ngx_l402-${VERSION}.tar.gz target/release/libngx_l402_lib.so
          gh release create ${GITHUB_REF#refs/tags/} ngx_l402-${VERSION}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}