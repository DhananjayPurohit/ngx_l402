name: Integration Tests

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      RUST_BACKTRACE: full
      RUST_LOG: debug

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo registry + build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-export-modules-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev protobuf-compiler

      - name: Build module for l402
        run: cargo build --release --features export-modules

      - name: Set up Docker Compose
        env:
          ROOT_KEY: ${{ secrets.ROOT_KEY }}
          CURRENCY: USD
          AMOUNT: 0.01
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.5.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose -f docker-compose.yml up -d bitcoind

      - name: Create env file
        run: |
          touch .env
          echo ROOT_KEY=${{ secrets.ROOT_KEY }} >> .env
          cat .env

      - name: Start LNURL service
        env:
          LNURL_ADDRESS: ${{ secrets.LNURL_ADDRESS }}
        run: |
          docker-compose -f docker-compose.yml up -d nginx-lnurl grpc-content-server

      - name: Run Integration Tests - LNURL
        run: |
          docker logs nginx-lnurl
          echo "Testing with LNURL configuration..."
          sleep 15

          # Test free route
          echo "Testing free route..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Free route returned status $status_code, expected 200"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test protected route without header
          echo "Testing protected route without header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route without header returned status $status_code, expected 402"
            docker logs nginx-lnurl
            exit 1
          fi

          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test with valid L402 credentials
          echo "Testing with valid L402 credentials..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:e582fba50ca50a9a262cbb92fc38617ce0a2413ef1dd4c7062cbaef22b33a404" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with valid L402 returned status $status_code, expected 200"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test with invalid preimage
          echo "Testing with invalid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:fbe9ac25c04e14b10177514e2d57b0e39224e70277ac1a2cd23c28e58cd4ea35" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid preimage returned status $status_code, expected 401"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test with macaroon without caveats
          echo "Testing with macaroon without caveats..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 AgEETFNBVALmAUr/gQMBARJNYWNhcm9vbklkZW50aWZpZXIB/4IAAQMBB1ZlcnNpb24BBgABC1BheW1lbnRIYXNoAf+EAAEHVG9rZW5JZAH/hgAAABT/gwEBAQRIYXNoAf+EAAEGAUAAABn/hQEBAQlbMzJddWludDgB/4YAAQYBQAAAa/+CAiD/pv/jOjY1/9oC/4z/tHb/qf/2Jf+d/4H/u/+YGHj/+/+O/8D/v/+P/8X/qRL/5v/x/4r/tkIBIA1Y/8j/pR3/0P+b/7cwWP+W/87/sD18GP//Hf/f/9Aj//NcBFs2/9VhNEUF/70AAAAGIDlR1jVm5IfEJgvuSQoJLqLg4FcW4Ib1vW8sbkRHdUWX:651505fae9ea341c770c6ebef207d8560d546eb3aee26985e584c15d1c987875" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with macaroon without caveats returned status $status_code, expected 401"
            docker logs nginx-lnurl
            exit 1
          fi

      - name: Run Integration Tests - gRPC
        run: |
          docker logs grpc-content-server
          echo "Testing gRPC server..."
          sleep 5

          # Install grpcurl for testing gRPC endpoints
          echo "Installing grpcurl..."
          curl -L https://github.com/fullstorydev/grpcurl/releases/download/v1.8.9/grpcurl_1.8.9_linux_x86_64.tar.gz | tar -xzf - -C /tmp
          sudo mv /tmp/grpcurl /usr/local/bin/

          # Test gRPC service reflection
          echo "Testing gRPC service reflection..."
          grpcurl -plaintext localhost:50051 list || {
            echo "Error: gRPC reflection failed"
            docker logs grpc-content-server
            exit 1
          }

          # Test GetContent method
          echo "Testing GetContent method..."
          response=$(grpcurl -plaintext -d '{"path": "/test.txt"}' localhost:50051 content.ContentService/GetContent)
          if ! echo "$response" | grep -q "Content for path"; then
            echo "Error: GetContent method failed"
            echo "Response: $response"
            docker logs grpc-content-server
            exit 1
          fi

          # Test GetProtectedContent method
          echo "Testing GetProtectedContent method..."
          response=$(grpcurl -plaintext -d '{"path": "/protected"}' localhost:50051 content.ContentService/GetProtectedContent)
          if ! echo "$response" | grep -q "This is Protected Content"; then
            echo "Error: GetProtectedContent method failed"
            echo "Response: $response"
            docker logs grpc-content-server
            exit 1
          fi

          # Test GetFreeContent method
          echo "Testing GetFreeContent method..."
          response=$(grpcurl -plaintext -d '{"path": "/free"}' localhost:50051 content.ContentService/GetFreeContent)
          if ! echo "$response" | grep -q "Free Content"; then
            echo "Error: GetFreeContent method failed"
            echo "Response: $response"
            docker logs grpc-content-server
            exit 1
          fi

          # Test gRPC through nginx proxy (L402 protected)
          echo "Testing gRPC through nginx proxy with L402 protection..."
          
          # First test without L402 header - should get 402
          echo "Testing gRPC endpoint without L402 header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -H "Content-Type: application/grpc" -H "grpc-timeout: 60S" -X POST http://0.0.0.0:8000/content.ContentService/GetProtectedContent)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: gRPC endpoint without L402 returned status $status_code, expected 402"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi
          
          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response for gRPC"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test with valid L402 credentials for gRPC
          echo "Testing gRPC endpoint with valid L402 credentials..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -H "Content-Type: application/grpc" -H "grpc-timeout: 60S" -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:e582fba50ca50a9a262cbb92fc38617ce0a2413ef1dd4c7062cbaef22b33a404" -X POST http://0.0.0.0:8000/content.ContentService/GetProtectedContent)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: gRPC endpoint with valid L402 returned status $status_code, expected 200"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi

          echo "All gRPC tests completed successfully!"

      - name: Stop LNURL service
        run: |
          docker-compose -f docker-compose.yml stop nginx-lnurl

      - name: Start LND node, LND node receiver and cashu-mint
        run: |
          docker-compose -f docker-compose.yml up -d --no-deps lndnode lndnode-receiver cashu-mint
          echo "waiting for 30 seconds..."
          sleep 30

      - name: Verify Bitcoin daemon Service, create wallet and fund lndnode and lndnode-receiver
        run: |
          #!/bin/bash

          wallet_name="my_wallet"
          echo "Using wallet: $wallet_name"

          # Check if wallet exists, create/load it
          if docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass listwallets | grep -q "\"$wallet_name\""; then
              echo "Wallet $wallet_name exists, loading..."
              docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass loadwallet "$wallet_name" 2>/dev/null
          else
              echo "Creating wallet $wallet_name..."
              docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass createwallet "$wallet_name"
          fi

          # Generate an address in this wallet
          fund_address=$(docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name getnewaddress)
          echo "Mining 101 blocks to $fund_address..."
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name generatetoaddress 101 "$fund_address" >> /dev/null

          echo "Sleeping 5 seconds..."
          sleep 5

          # ------- FUND LND NODE -------
          echo "Funding LND node..."

          # Print initial LND node balance
          initial_balance=$(docker exec lndnode lncli -n regtest walletbalance | jq -r '.confirmed_balance')
          echo "Initial LND node balance: $initial_balance sats"

          # Fund LND node
          lnd_addr=$(docker exec lndnode lncli -n regtest newaddress p2wkh | jq -r '.address')
          echo "Sending 1 BTC to LND node at $lnd_addr..."
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name sendtoaddress "$lnd_addr" 1

          # Mine 6 blocks to confirm funding
          new_addr=$(docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name getnewaddress)
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name generatetoaddress 6 "$new_addr"

          # Print final LND node balance
          final_balance=$(docker exec lndnode lncli -n regtest walletbalance | jq -r '.confirmed_balance')
          echo "Final LND node balance: $final_balance sats"

          echo "✅ LND node funded successfully!"

          # ------- FUND LND-receiver NODE -------
          echo "Funding LND-receiver node..."

          # Print initial LND-receiver node balance
          initial_balance=$(docker exec lndnode-receiver lncli --rpcserver=127.0.0.1:10010 -n regtest walletbalance | jq -r '.confirmed_balance')
          echo "Initial LND-receiver node balance: $initial_balance sats"

          # Fund LND-receiver node
          lnd_addr=$(docker exec lndnode-receiver lncli --rpcserver=127.0.0.1:10010 -n regtest newaddress p2wkh | jq -r '.address')
          echo "Sending 1 BTC to LND-receiver node at $lnd_addr..."
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name sendtoaddress "$lnd_addr" 1

          # Mine 6 blocks to confirm funding
          new_addr=$(docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name getnewaddress)
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name generatetoaddress 6 "$new_addr"

          echo "✅ LND-receiver node funded successfully!"

          # -------- CHANNEL (LND NODE RECEIVER - LND NODE) --------
          echo "Opening channel from LND-receiver node to LND node..."

          # Step 1: Get LND node pubkey
          LNDNODE_PUBKEY=$(docker exec lndnode lncli -n regtest getinfo | jq -r '.identity_pubkey')
          echo "LND node pubkey: $LNDNODE_PUBKEY"

          # Step 2: Connect receiver to LND node
          echo "Connecting LND-receiver to LND node..."
          docker exec lndnode-receiver lncli --network=regtest --rpcserver=127.0.0.1:10010 connect "$LNDNODE_PUBKEY"@lndnode:9735 || true

          # Step 3: Open channel from receiver to LND node
          echo "Opening channel from LND-receiver to LND node..."
          docker exec lndnode-receiver lncli --network=regtest --rpcserver=127.0.0.1:10010 openchannel --node_key="$LNDNODE_PUBKEY" --local_amt=1000000

          # Step 4: Mine 6 blocks to confirm channel
          echo "Mining 6 blocks to confirm channel..."
          docker exec bitcoind sh -c "bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name generatetoaddress 6 \$(bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name getnewaddress)"

          # Wait until channels are active
          echo "Waiting for channels to become active..."
          until docker exec lndnode lncli -n regtest listchannels | grep -q '"active": true'; do
            sleep 2
          done

          echo "✅ Channel lndnode-receiver to lndnode opened successfully!"

          # -------- CHANNEL (LND NODE - LND NODE RECEIVER) --------
          echo "Opening channel from LND node to LND-receiver node..."

          # Step 1: Get LND-receiver node pubkey
          LNDRECEIVER_PUBKEY=$(docker exec lndnode-receiver lncli --rpcserver=127.0.0.1:10010 -n regtest getinfo | jq -r '.identity_pubkey')
          echo "LND-receiver node pubkey: $LNDRECEIVER_PUBKEY"

          # Step 2: Connect receiver to LND node
          echo "Connecting LND to LND-receiver node..."
          docker exec lndnode lncli --network=regtest connect "$LNDRECEIVER_PUBKEY"@lndnode-receiver:9735 || true

          # Step 3: Open channel from receiver to LND node
          echo "Opening channel from LND to LND-receiver node..."
          docker exec lndnode lncli --network=regtest openchannel --node_key="$LNDRECEIVER_PUBKEY" --local_amt=1000000

          # Step 4: Mine 6 blocks to confirm channel
          echo "Mining 6 blocks to confirm channel..."
          docker exec bitcoind sh -c "bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name generatetoaddress 6 \$(bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name getnewaddress)"

          until docker exec lndnode-receiver lncli --rpcserver=127.0.0.1:10010 -n regtest listchannels | grep -q '"active": true'; do
            sleep 2
          done

          echo "✅ Channel lndnode to lndnode-receiver opened successfully!"

          # ------- CASHU SETUP -------
          echo 'Creating Cashu invoice...'

          docker exec cashu-mint sh -c "poetry run cashu invoice 25000 2>&1" > /tmp/cashu_output.txt &

          sleep 3

          CASHU_INVOICE=$(grep 'Invoice:' /tmp/cashu_output.txt | tail -1 | cut -d' ' -f2 || true)

          echo "Cashu invoice: $CASHU_INVOICE"
          rm /tmp/cashu_output.txt

          if [ -n "$CASHU_INVOICE" ]; then
            echo 'Paying Cashu mint invoice...'
            docker exec lndnode-receiver lncli --network=regtest --rpcserver=localhost:10010 sendpayment --pay_req="$CASHU_INVOICE" -f
            sleep 3
          else
            echo 'Could not create Cashu invoice, skipping token minting'
          fi

          # Get Cashu balance
          CASHU_BALANCE=$(docker exec cashu-mint sh -c "poetry run cashu balance" 2>/dev/null | grep 'Balance:' | awk '{print $2}' || echo '0')
          echo "Cashu user wallet balance: $CASHU_BALANCE sats"

      - name: Start cln services
        run: |
          docker-compose -f docker-compose.yml up -d --no-deps cln nginx-cln

      - name: Run Integration Tests - CLN
        run: |
          echo "Testing with CLN configuration..."
          sleep 15

          docker exec nginx-cln chmod 777 /root /root/.lightning /root/.lightning/regtest

          # Test free route
          echo "Testing free route..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Free route returned status $status_code, expected 200"
            docker logs nginx-cln
            exit 1
          fi

          # Test with valid L402 credentials
          echo "Testing with valid L402 credentials..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:e582fba50ca50a9a262cbb92fc38617ce0a2413ef1dd4c7062cbaef22b33a404" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with valid L402 returned status $status_code, expected 200"
            docker logs nginx-cln
            exit 1
          fi

          # Test with invalid preimage
          echo "Testing with invalid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:fbe9ac25c04e14b10177514e2d57b0e39224e70277ac1a2cd23c28e58cd4ea35" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid preimage returned status $status_code, expected 401"
            docker logs nginx-cln
            exit 1
          fi

          # Test with macaroon without caveats
          echo "Testing with macaroon without caveats..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 AgEETFNBVALmAUr/gQMBARJNYWNhcm9vbklkZW50aWZpZXIB/4IAAQMBB1ZlcnNpb24BBgABC1BheW1lbnRIYXNoAf+EAAEHVG9rZW5JZAH/hgAAABT/gwEBAQRIYXNoAf+EAAEGAUAAABn/hQEBAQlbMzJddWludDgB/4YAAQYBQAAAa/+CAiD/pv/jOjY1/9oC/4z/tHb/qf/2Jf+d/4H/u/+YGHj/+/+O/8D/v/+P/8X/qRL/5v/x/4r/tkIBIA1Y/8j/pR3/0P+b/7cwWP+W/87/sD18GP//Hf/f/9Aj//NcBFs2/9VhNEUF/70AAAAGIDlR1jVm5IfEJgvuSQoJLqLg4FcW4Ib1vW8sbkRHdUWX:651505fae9ea341c770c6ebef207d8560d546eb3aee26985e584c15d1c987875" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with macaroon without caveats returned status $status_code, expected 401"
            docker logs nginx-cln
            exit 1
          fi

          # Test protected route without header
          echo "Testing protected route without header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 60 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route without header returned status $status_code, expected 402"
            docker logs nginx-cln
            exit 1
          fi
          
          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response"
            echo "$response"
            docker logs nginx-cln
            exit 1
          fi

      - name: Stop CLN service
        run: |
          docker-compose -f docker-compose.yml stop nginx-cln

      - name: Verify LND node
        run: |
          identity_pubkey_lndnode=$(docker exec lndnode lncli -n regtest getinfo | jq -r '.identity_pubkey')
          echo "Pubkey: $identity_pubkey_lndnode"
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -generate 5

          # Get node info for both lightning nodes
          echo "Getting CLN node info..."
          cln_pubkey=$(docker exec cln lightning-cli --network=regtest getinfo | jq -r '.id')
          echo "CLN pubkey: $cln_pubkey"

          echo "Getting LND node info..."
          lnd_pubkey=$(docker exec lndnode lncli -n regtest getinfo | jq -r '.identity_pubkey')
          echo "LND pubkey: $lnd_pubkey"

          # Generate a new address for LND node
          address=$(docker exec lndnode lncli -n regtest newaddress p2wkh | jq -r '.address')
          echo "Generated address for LND: $address"

          # Send 10 BTC to LND node
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass sendtoaddress "$address" 10
          
          # Generate blocks to confirm the transaction
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass generatetoaddress 6 "$address"

          # Connect nodes
          echo "Connecting LND to CLN..."
          docker exec lndnode lncli -n regtest connect $cln_pubkey@cln:9835

          # Open channel from LND to CLN
          echo "Opening channel from LND to CLN..."
          docker exec lndnode lncli -n regtest openchannel $cln_pubkey 1000000

          # Generate blocks to confirm channel
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass generatetoaddress 6 "$address"

          echo "NWC_URI=$(docker exec cln lightning-cli --network=regtest nip47-create label=nwc-for-l402 budget_msat=0 | jq -r '.uri')" >> $GITHUB_ENV

      - name: Start NWC service
        run: |
          docker-compose -f docker-compose.yml up -d --no-deps nginx-nwc

      - name: Run Integration Tests - NWC
        run: |
          echo "Testing with NWC configuration..."
          sleep 20

          # Test free route
          echo "Testing free route..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Free route returned status $status_code, expected 200"
            docker logs nginx-nwc
            exit 1
          fi

          # Test protected route with timeout without header
          echo "Testing protected route with timeout without header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 60 -L http://0.0.0.0:8000/protected-timeout)
          status_code=$(echo "$response" | tail -n1)
          echo "status_code: $status_code"
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route without header returned status $status_code, expected 402"
            docker logs nginx-nwc
            exit 1
          fi
          
          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response"
            echo "$response"
            docker logs nginx-nwc
            exit 1
          fi

          # Extract invoice from header
          invoice=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'invoice="[^"]*"' | cut -d'"' -f2)
          if [ -z "$invoice" ]; then
            echo "Error: No invoice found in WWW-Authenticate header"
            echo "$response"
            docker logs nginx-nwc
            exit 1
          fi
          echo "invoice: $invoice"

          # Pay invoice using LND to get preimage
          echo "Paying invoice through LND..."
          payment_result=$(docker exec lndnode lncli -n regtest payinvoice -f $invoice 2>&1)
          echo "payment_result: $payment_result"
          
          # Wait a few seconds for payment to settle
          echo "Waiting for payment to settle..."
          sleep 5
          
          # Get payment result with preimage
          payment_result=$(docker exec lndnode lncli -n regtest listpayments | jq -r '.payments[-1]')
          payment_status=$(echo "$payment_result" | jq -r '.status')
          echo "payment_result: $payment_result"
          echo "payment_status: $payment_status"
          
          if [ "$payment_status" != "SUCCEEDED" ]; then
            echo "Error: Payment failed or timed out"
            docker logs nginx-nwc
            exit 1
          fi

          # Extract preimage from payment result
          preimage=$(echo "$payment_result" | jq -r '.payment_preimage')
          macaroon=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'macaroon="[^"]*"' | cut -d'"' -f2)

          # Wait for preimage to be registered in the system
          echo "Waiting for preimage registration..."
          sleep 5

          # Test with obtained preimage
          echo "Testing protected route with valid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 $macaroon:$preimage" http://0.0.0.0:8000/protected-timeout)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with valid preimage returned status $status_code, expected 200"
            docker logs nginx-nwc
            exit 1
          fi

          # Wait for macaroon to expire (10 seconds)
          echo "Waiting for macaroon to expire..."
          sleep 15

          # Test with expired macaroon
          echo "Testing protected route with expired macaroon..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 $macaroon:$preimage" http://0.0.0.0:8000/protected-timeout)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with expired macaroon returned status $status_code, expected 401"
            docker logs nginx-nwc
            exit 1
          fi

          # Test with invalid preimage
          echo "Testing with invalid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:fbe9ac25c04e14b10177514e2d57b0e39224e70277ac1a2cd23c28e58cd4ea35" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid preimage returned status $status_code, expected 401"
            docker logs nginx-nwc
            exit 1
          fi

          # Test with macaroon without caveats
          echo "Testing with macaroon without caveats..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 AgEETFNBVALmAUr/gQMBARJNYWNhcm9vbklkZW50aWZpZXIB/4IAAQMBB1ZlcnNpb24BBgABC1BheW1lbnRIYXNoAf+EAAEHVG9rZW5JZAH/hgAAABT/gwEBAQRIYXNoAf+EAAEGAUAAABn/hQEBAQlbMzJddWludDgB/4YAAQYBQAAAa/+CAiD/pv/jOjY1/9oC/4z/tHb/qf/2Jf+d/4H/u/+YGHj/+/+O/8D/v/+P/8X/qRL/5v/x/4r/tkIBIA1Y/8j/pR3/0P+b/7cwWP+W/87/sD18GP//Hf/f/9Aj//NcBFs2/9VhNEUF/70AAAAGIDlR1jVm5IfEJgvuSQoJLqLg4FcW4Ib1vW8sbkRHdUWX:651505fae9ea341c770c6ebef207d8560d546eb3aee26985e584c15d1c987875" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with macaroon without caveats returned status $status_code, expected 401"
            docker logs nginx-nwc
            exit 1
          fi

      - name: Stop NWC service and CLN node
        run: |
          docker-compose -f docker-compose.yml stop nginx-nwc cln

      - name: Start nginx containers for LND
        env:
          CURRENCY: USD
          AMOUNT: 0.01
        run: |
          # Start the remaining services
          docker-compose -f docker-compose.yml up -d --no-deps nginx-lnd redis

      - name: Run Integration Tests - LND
        run: |
          docker ps -a
          echo "Testing with LND configuration..."
          sleep 15

          # Test free route
          echo "Testing free route..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Free route returned status $status_code, expected 200"
            docker logs nginx-lnd
            exit 1
          fi

          # Test protected route without header
          echo "Testing protected route without header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route without header returned status $status_code, expected 402"
            docker logs nginx-lnd
            exit 1
          fi
          
          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Extract and verify invoice amount
          invoice=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'invoice="[^"]*"' | cut -d'"' -f2)
          if [ -z "$invoice" ]; then
            echo "Error: No invoice found in WWW-Authenticate header"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi

          # Decode invoice and check amount
          decoded_amount=$(docker exec lndnode lncli -n regtest decodepayreq "$invoice" | jq -r '.num_msat')
          if [ "$decoded_amount" != "10000" ]; then
            echo "Error: Invoice amount is $decoded_amount msat, expected 10000 msat"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Test dynamic pricing by setting a new price in Redis
          echo "Setting dynamic price to 15000 msat..."
          docker exec redis redis-cli set /protected 15000

          # Test protected route to get new invoice with dynamic price
          echo "Testing protected route with dynamic price..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route with dynamic price returned status $status_code, expected 402"
            docker logs nginx-lnd
            exit 1
          fi

          # Extract and verify new invoice amount
          invoice=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'invoice="[^"]*"' | cut -d'"' -f2)
          if [ -z "$invoice" ]; then
            echo "Error: No invoice found in WWW-Authenticate header for dynamic price"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Decode invoice and check dynamic amount
          decoded_amount=$(docker exec lndnode lncli -n regtest decodepayreq "$invoice" | jq -r '.num_msat')
          if [ "$decoded_amount" != "15000" ]; then
            echo "Error: Dynamic invoice amount is $decoded_amount msat, expected 15000 msat"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Reset price back to default
          echo "Resetting price back to default..."
          docker exec redis redis-cli del /protected

          # Test protected route to verify reset price
          echo "Testing protected route with reset price..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route with reset price returned status $status_code, expected 402"
            docker logs nginx-lnd
            exit 1
          fi

          # Extract and verify reset invoice amount
          invoice=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'invoice="[^"]*"' | cut -d'"' -f2)
          if [ -z "$invoice" ]; then
            echo "Error: No invoice found in WWW-Authenticate header after reset"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Decode invoice and check reset amount
          decoded_amount=$(docker exec lndnode lncli -n regtest decodepayreq "$invoice" | jq -r '.num_msat')
          if [ "$decoded_amount" != "10000" ]; then
            echo "Error: Reset invoice amount is $decoded_amount msat, expected 10000 msat"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Test with valid L402 credentials
          echo "Testing with valid L402 credentials..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:e582fba50ca50a9a262cbb92fc38617ce0a2413ef1dd4c7062cbaef22b33a404" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with valid L402 returned status $status_code, expected 200"
            docker logs nginx-lnd
            exit 1
          fi

          # Test with invalid preimage
          echo "Testing with invalid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:fbe9ac25c04e14b10177514e2d57b0e39224e70277ac1a2cd23c28e58cd4ea35" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid preimage returned status $status_code, expected 401"
            docker logs nginx-lnd
            exit 1
          fi

          # Test with macaroon without caveats
          echo "Testing with macaroon without caveats..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 AgEETFNBVALmAUr/gQMBARJNYWNhcm9vbklkZW50aWZpZXIB/4IAAQMBB1ZlcnNpb24BBgABC1BheW1lbnRIYXNoAf+EAAEHVG9rZW5JZAH/hgAAABT/gwEBAQRIYXNoAf+EAAEGAUAAABn/hQEBAQlbMzJddWludDgB/4YAAQYBQAAAa/+CAiD/pv/jOjY1/9oC/4z/tHb/qf/2Jf+d/4H/u/+YGHj/+/+O/8D/v/+P/8X/qRL/5v/x/4r/tkIBIA1Y/8j/pR3/0P+b/7cwWP+W/87/sD18GP//Hf/f/9Aj//NcBFs2/9VhNEUF/70AAAAGIDlR1jVm5IfEJgvuSQoJLqLg4FcW4Ib1vW8sbkRHdUWX:651505fae9ea341c770c6ebef207d8560d546eb3aee26985e584c15d1c987875" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with macaroon without caveats returned status $status_code, expected 401"
            docker logs nginx-lnd
            exit 1
          fi

          # Test Cashu eCash support
          echo "Testing Cashu eCash support..."

          # Ensure the Cashu database has proper permissions
          echo "Setting up Cashu database permissions..."
          docker exec nginx-lnd chmod 770 /app/data
          docker exec nginx-lnd chmod 660 /app/data/cashu_tokens.db
          echo "Cashu database permissions set successfully"
          
          # Check mint logs
          docker logs cashu-mint
          
          # Execute cashu commands inside the mint container using poetry run
          echo "Executing cashu commands inside the mint container..."
          
          # Check wallet info
          echo "Checking wallet info..."
          docker exec cashu-mint poetry run cashu info
          
          # Check initial balance
          echo "Checking initial balance..."
          docker exec cashu-mint poetry run cashu balance
          
          # Check balance after minting
          echo "Checking balance after minting..."
          docker exec cashu-mint poetry run cashu balance
          
          # Get token from wallet
          echo "Retrieving token from wallet..."
          CASHU_TOKEN=$(docker exec cashu-mint poetry run cashu send 10)
          
          echo "Cashu token: $CASHU_TOKEN"

          sleep 5
          
          # Test protected route with Cashu token
          echo "Testing protected route with Cashu token..."
          max_retries=3
          retry_count=0
          status_code=0
          
          while [ $retry_count -lt $max_retries ] && [ "$status_code" -ne 200 ]; do
            echo "Attempt $(($retry_count + 1)) of $max_retries..."
            response=$(curl -v -s -i -w "\n%{http_code}" --max-time 60 -L -H "Authorization: Cashu $CASHU_TOKEN" http://0.0.0.0:8000/protected)
            status_code=$(echo "$response" | tail -n1)
            
            if [ "$status_code" -ne 200 ]; then
              if echo "$response" | grep -q "401 Unauthorized"; then
                echo "Pool connection timed out, retrying..."
                sleep 5
                retry_count=$((retry_count + 1))
              else
                break
              fi
            fi
          done
          
          # The token should be accepted if the verification logic is working
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with Cashu token returned unexpected status $status_code"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi
          
          # Test with invalid Cashu token (insufficient amount)
          echo "Testing with invalid Cashu token (insufficient amount)..."
          
          INVALID_CASHU_TOKEN=$(docker exec cashu-mint poetry run cashu send 1)

          sleep 5
          
          # Test with the invalid token
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $INVALID_CASHU_TOKEN" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          
          # This should fail verification due to insufficient amount
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid Cashu token returned status $status_code, expected 401"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi
          
          # Test with malformed Cashu token
          echo "Testing with malformed Cashu token..."
          
          # Create a malformed token
          MALFORMED_CASHU_TOKEN='{
            "token": [
              {
                "mint": "http://cashu-mint:3338",
                "proofs": []
              }
            ]
          }'
          
          # Encode the malformed token
          ENCODED_MALFORMED_TOKEN=$(echo -n "$MALFORMED_CASHU_TOKEN" | base64 -w 0)

          sleep 5
          
          # Test with the malformed token
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $ENCODED_MALFORMED_TOKEN" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          
          # This should fail verification due to empty proofs
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with malformed Cashu token returned status $status_code, expected 401"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi
          
          # Test whitelisted mints functionality
          echo "Testing whitelisted mints functionality..."
          
          # Test with token from non-whitelisted mint
          echo "Testing with token from non-whitelisted mint (https://nofees.testnut.cashu.space)..."
          
          # Create a token with a non-whitelisted mint URL
          NON_WHITELISTED_TOKEN='{
            "token": [
              {
                "mint": "https://nofees.testnut.cashu.space",
                "proofs": [
                  {
                    "id": "test-proof",
                    "amount": 10,
                    "secret": "test-secret",
                    "C": "test-commitment"
                  }
                ]
              }
            ]
          }'
          
          # Encode the non-whitelisted token
          ENCODED_NON_WHITELISTED_TOKEN=$(echo -n "$NON_WHITELISTED_TOKEN" | base64 -w 0)

          sleep 5
          
          # Test with the non-whitelisted token
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $ENCODED_NON_WHITELISTED_TOKEN" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          
          # This should fail verification due to non-whitelisted mint
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with non-whitelisted Cashu token returned status $status_code, expected 401"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi
          
          echo "✅ Non-whitelisted mint token (https://nofees.testnut.cashu.space) correctly rejected!"
          
          echo "All Cashu eCash tests completed successfully!"
          docker logs nginx-lnd

      - name: Run Integration test - Cashu redemption on lightening
        run: |
          echo "Running Cashu redemption on Lightning test..."
          cashu_token=$(docker exec cashu-mint poetry run cashu send 50)

          INITIAL_BALANCE=$(docker exec lndnode-receiver lncli --rpcserver=127.0.0.1:10010 -n regtest walletbalance | jq -r '.confirmed_balance')

          echo "Initial LND Wallet Balance: $INITIAL_BALANCE sats"

          echo "Cashu Token: $cashu_token"

          # access protected nginx-cln route with cashu token
          response=$(curl -s -w "\n%{http_code}" --max-time 60 -L -H "Authorization: Cashu $cashu_token" http://0.0.0.0:8000/protected) 

          if [ "$(echo "$response" | tail -n1)" -ne 200 ]; then
            echo "Error: unable to access protected route with Cashu token with response $(echo "$response" | tail -n1)"
            docker logs nginx-cln
            exit 1
          fi

          echo "Cashu token consumed successfully to access protected route."

          REDEMPTION_INTERVAL=$(docker exec nginx-lnd env | grep CASHU_REDEMPTION_INTERVAL_SECS | cut -d'=' -f2 || echo "not_set")
          WAIT_TIME=$((REDEMPTION_INTERVAL + 30))

          echo "Waiting for $WAIT_TIME seconds to allow redemption process to complete..."
          sleep $WAIT_TIME

          FINAL_BALANCE=$(docker exec lndnode-receiver lncli --rpcserver=127.0.0.1:10010 -n regtest walletbalance | jq -r '.confirmed_balance')

          echo "Final LND Wallet Balance: $FINAL_BALANCE sats"

          BALANCE_DIFFERENCE=$((FINAL_BALANCE - INITIAL_BALANCE))
          echo "Balance Difference: $BALANCE_DIFFERENCE sats"

          if [ "$BALANCE_DIFFERENCE" -gt 0 ]; then
            echo "✅ LND received payments from Cashu token redemption ($BALANCE_DIFFERENCE sats)"
          else
            echo "No redemption activity"
            docker logs nginx-lnd
            exit 1
          fi

          echo "✅ Cashu redeem on lightning integration tests completed!"

      - name: Publish .so file
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          tar -czf ngx_l402-${VERSION}.tar.gz target/release/libngx_l402_lib.so
          gh release create ${GITHUB_REF#refs/tags/} ngx_l402-${VERSION}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}