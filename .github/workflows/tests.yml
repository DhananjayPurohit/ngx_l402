name: Integration Tests

on:
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      RUST_BACKTRACE: full
      RUST_LOG: debug

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Cargo registry + build
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-export-modules-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev protobuf-compiler

      - name: Build module for l402
        run: cargo build --release --features export-modules

      - name: Set up Docker Compose
        env:
          ROOT_KEY: ABDEGHKLMPTC
          CURRENCY: USD
          AMOUNT: 0.01
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.5.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose -f docker-compose.yml up -d bitcoind

      - name: Create env file
        run: |
          touch .env
          echo ROOT_KEY=ABDEGHKLMPTC >> .env
          cat .env

      - name: Start nginx-lnurl service
        env:
          LNURL_ADDRESS: hello@getalby.com
        run: |
          docker-compose -f docker-compose.yml up -d nginx-lnurl grpc-content-server

      - name: Run Integration Tests - LNURL
        run: |
          docker logs nginx-lnurl
          echo "Testing with LNURL configuration..."
          sleep 15

          # Test free route
          echo "Testing free route..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Free route returned status $status_code, expected 200"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test protected route without header
          echo "Testing protected route without header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route without header returned status $status_code, expected 402"
            docker logs nginx-lnurl
            exit 1
          fi

          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test with valid L402 credentials
          echo "Testing with valid L402 credentials..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:e582fba50ca50a9a262cbb92fc38617ce0a2413ef1dd4c7062cbaef22b33a404" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with valid L402 returned status $status_code, expected 200"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test with invalid preimage
          echo "Testing with invalid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:fbe9ac25c04e14b10177514e2d57b0e39224e70277ac1a2cd23c28e58cd4ea35" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid preimage returned status $status_code, expected 401"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test with macaroon without caveats
          echo "Testing with macaroon without caveats..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 AgEETFNBVALmAUr/gQMBARJNYWNhcm9vbklkZW50aWZpZXIB/4IAAQMBB1ZlcnNpb24BBgABC1BheW1lbnRIYXNoAf+EAAEHVG9rZW5JZAH/hgAAABT/gwEBAQRIYXNoAf+EAAEGAUAAABn/hQEBAQlbMzJddWludDgB/4YAAQYBQAAAa/+CAiD/pv/jOjY1/9oC/4z/tHb/qf/2Jf+d/4H/u/+YGHj/+/+O/8D/v/+P/8X/qRL/5v/x/4r/tkIBIA1Y/8j/pR3/0P+b/7cwWP+W/87/sD18GP//Hf/f/9Aj//NcBFs2/9VhNEUF/70AAAAGIDlR1jVm5IfEJgvuSQoJLqLg4FcW4Ib1vW8sbkRHdUWX:651505fae9ea341c770c6ebef207d8560d546eb3aee26985e584c15d1c987875" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with macaroon without caveats returned status $status_code, expected 401"
            docker logs nginx-lnurl
            exit 1
          fi

      - name: Run Integration Tests - gRPC
        run: |
          docker logs grpc-content-server
          echo "Testing gRPC server..."
          sleep 5

          # Install grpcurl for testing gRPC endpoints
          echo "Installing grpcurl..."
          curl -L https://github.com/fullstorydev/grpcurl/releases/download/v1.8.9/grpcurl_1.8.9_linux_x86_64.tar.gz | tar -xzf - -C /tmp
          sudo mv /tmp/grpcurl /usr/local/bin/

          # Test gRPC service reflection
          echo "Testing gRPC service reflection..."
          grpcurl -plaintext localhost:50051 list || {
            echo "Error: gRPC reflection failed"
            docker logs grpc-content-server
            exit 1
          }

          # Test GetContent method
          echo "Testing GetContent method..."
          response=$(grpcurl -plaintext -d '{"path": "/test.txt"}' localhost:50051 content.ContentService/GetContent)
          if ! echo "$response" | grep -q "Content for path"; then
            echo "Error: GetContent method failed"
            echo "Response: $response"
            docker logs grpc-content-server
            exit 1
          fi

          # Test GetProtectedContent method
          echo "Testing GetProtectedContent method..."
          response=$(grpcurl -plaintext -d '{"path": "/protected"}' localhost:50051 content.ContentService/GetProtectedContent)
          if ! echo "$response" | grep -q "This is Protected Content"; then
            echo "Error: GetProtectedContent method failed"
            echo "Response: $response"
            docker logs grpc-content-server
            exit 1
          fi

          # Test GetFreeContent method
          echo "Testing GetFreeContent method..."
          response=$(grpcurl -plaintext -d '{"path": "/free"}' localhost:50051 content.ContentService/GetFreeContent)
          if ! echo "$response" | grep -q "Free Content"; then
            echo "Error: GetFreeContent method failed"
            echo "Response: $response"
            docker logs grpc-content-server
            exit 1
          fi

          # Test gRPC through nginx proxy (L402 protected)
          echo "Testing gRPC through nginx proxy with L402 protection..."
          
          # First test without L402 header - should get 402
          echo "Testing gRPC endpoint without L402 header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -H "Content-Type: application/grpc" -H "grpc-timeout: 60S" -X POST http://0.0.0.0:8000/content.ContentService/GetProtectedContent)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: gRPC endpoint without L402 returned status $status_code, expected 402"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi
          
          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response for gRPC"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi

          # Test with valid L402 credentials for gRPC
          echo "Testing gRPC endpoint with valid L402 credentials..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -H "Content-Type: application/grpc" -H "grpc-timeout: 60S" -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:e582fba50ca50a9a262cbb92fc38617ce0a2413ef1dd4c7062cbaef22b33a404" -X POST http://0.0.0.0:8000/content.ContentService/GetProtectedContent)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: gRPC endpoint with valid L402 returned status $status_code, expected 200"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi

          echo "All gRPC tests completed successfully!"

      - name: Stop LNURL service
        run: |
          docker-compose -f docker-compose.yml stop nginx-lnurl

      - name: Start LND node, LND node receiver and cashu-mint
        run: |
          docker-compose -f docker-compose.yml up -d --no-deps lndnode lndnode-receiver cashu-mint
          echo "waiting for 30 seconds..."
          sleep 30

      - name: Verify Bitcoin daemon Service, create wallet and fund lndnode and lndnode-receiver
        run: |
          #!/bin/bash

          wallet_name="my_wallet"
          echo "Using wallet: $wallet_name"

          # Check if wallet exists, create/load it
          if docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass listwallets | grep -q "\"$wallet_name\""; then
              echo "Wallet $wallet_name exists, loading..."
              docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass loadwallet "$wallet_name" 2>/dev/null
          else
              echo "Creating wallet $wallet_name..."
              docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass createwallet "$wallet_name"
          fi

          # Generate an address in this wallet
          fund_address=$(docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name getnewaddress)
          echo "Mining 101 blocks to $fund_address..."
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name generatetoaddress 101 "$fund_address" >> /dev/null

          echo "Sleeping 5 seconds..."
          sleep 5

          # ------- FUND LND NODE -------
          echo "Funding LND node..."

          # Print initial LND node balance
          initial_balance=$(docker exec lndnode lncli -n regtest walletbalance | jq -r '.confirmed_balance')
          echo "Initial LND node balance: $initial_balance sats"

          # Fund LND node
          lnd_addr=$(docker exec lndnode lncli -n regtest newaddress p2wkh | jq -r '.address')
          echo "Sending 1 BTC to LND node at $lnd_addr..."
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name sendtoaddress "$lnd_addr" 1

          # Mine 6 blocks to confirm funding
          new_addr=$(docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name getnewaddress)
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name generatetoaddress 6 "$new_addr"

          # Print final LND node balance
          final_balance=$(docker exec lndnode lncli -n regtest walletbalance | jq -r '.confirmed_balance')
          echo "Final LND node balance: $final_balance sats"

          echo "âœ… LND node funded successfully!"

          # ------- FUND LND-receiver NODE -------
          echo "Funding LND-receiver node..."

          # Print initial LND-receiver node balance
          initial_balance=$(docker exec lndnode-receiver lncli --rpcserver=127.0.0.1:10010 -n regtest walletbalance | jq -r '.confirmed_balance')
          echo "Initial LND-receiver node balance: $initial_balance sats"

          # Fund LND-receiver node
          lnd_addr=$(docker exec lndnode-receiver lncli --rpcserver=127.0.0.1:10010 -n regtest newaddress p2wkh | jq -r '.address')
          echo "Sending 1 BTC to LND-receiver node at $lnd_addr..."
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name sendtoaddress "$lnd_addr" 1

          # Mine 6 blocks to confirm funding
          new_addr=$(docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name getnewaddress)
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name generatetoaddress 6 "$new_addr"

          echo "âœ… LND-receiver node funded successfully!"

          # -------- CHANNEL (LND NODE RECEIVER - LND NODE) --------
          echo "Opening channel from LND-receiver node to LND node..."

          # Step 1: Get LND node pubkey
          LNDNODE_PUBKEY=$(docker exec lndnode lncli -n regtest getinfo | jq -r '.identity_pubkey')
          echo "LND node pubkey: $LNDNODE_PUBKEY"

          # Step 2: Connect receiver to LND node
          echo "Connecting LND-receiver to LND node..."
          docker exec lndnode-receiver lncli --network=regtest --rpcserver=127.0.0.1:10010 connect "$LNDNODE_PUBKEY"@lndnode:9735 || true

          # Step 3: Open channel from receiver to LND node
          echo "Opening channel from LND-receiver to LND node..."
          docker exec lndnode-receiver lncli --network=regtest --rpcserver=127.0.0.1:10010 openchannel --node_key="$LNDNODE_PUBKEY" --local_amt=1000000

          # Step 4: Mine 6 blocks to confirm channel
          echo "Mining 6 blocks to confirm channel..."
          docker exec bitcoind sh -c "bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name generatetoaddress 6 \$(bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -rpcwallet=$wallet_name getnewaddress)"

          echo "âœ… Channel lndnode-receiver to lndnode opened successfully!"

          # ------- CASHU SETUP -------
          echo 'Creating Cashu invoice...'

          docker exec cashu-mint sh -c "poetry run cashu invoice 25000 2>&1" > /tmp/cashu_output.txt &

          sleep 3

          CASHU_INVOICE=$(grep 'Invoice:' /tmp/cashu_output.txt | tail -1 | cut -d' ' -f2 || true)

          echo "Cashu invoice: $CASHU_INVOICE"
          rm /tmp/cashu_output.txt

          if [ -n "$CASHU_INVOICE" ]; then
            echo 'Paying Cashu mint invoice...'
            docker exec lndnode-receiver lncli --network=regtest --rpcserver=localhost:10010 sendpayment --pay_req="$CASHU_INVOICE" -f
            sleep 3
          else
            echo 'Could not create Cashu invoice, skipping token minting'
          fi

          # Get Cashu balance
          CASHU_BALANCE=$(docker exec cashu-mint sh -c "poetry run cashu balance" 2>/dev/null | grep 'Balance:' | awk '{print $2}' || echo '0')
          echo "Cashu user wallet balance: $CASHU_BALANCE sats"

          # ------ LIQUIDITY --------
          echo "Pushing liquidity from lndnode to lndnode-receiver..."
          INVOICE=$(docker exec lndnode lncli -n regtest addinvoice --amt=8000 | jq -r '.payment_request')
          docker exec lndnode-receiver lncli -n regtest --rpcserver=127.0.0.1:10010 payinvoice --force "$INVOICE"
          sleep 3
          echo "âœ… Liquidity pushed successfully!"

      - name: Start cln services
        run: |
          docker-compose -f docker-compose.yml up -d --no-deps cln nginx-cln

      - name: Run Integration Tests - CLN
        run: |
          echo "Testing with CLN configuration..."
          sleep 15

          docker exec nginx-cln chmod 777 /root /root/.lightning /root/.lightning/regtest

          # Test free route
          echo "Testing free route..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Free route returned status $status_code, expected 200"
            docker logs nginx-cln
            exit 1
          fi

          # Test with valid L402 credentials
          echo "Testing with valid L402 credentials..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:e582fba50ca50a9a262cbb92fc38617ce0a2413ef1dd4c7062cbaef22b33a404" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with valid L402 returned status $status_code, expected 200"
            docker logs nginx-cln
            exit 1
          fi

          # Test with invalid preimage
          echo "Testing with invalid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:fbe9ac25c04e14b10177514e2d57b0e39224e70277ac1a2cd23c28e58cd4ea35" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid preimage returned status $status_code, expected 401"
            docker logs nginx-cln
            exit 1
          fi

          # Test with macaroon without caveats
          echo "Testing with macaroon without caveats..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 AgEETFNBVALmAUr/gQMBARJNYWNhcm9vbklkZW50aWZpZXIB/4IAAQMBB1ZlcnNpb24BBgABC1BheW1lbnRIYXNoAf+EAAEHVG9rZW5JZAH/hgAAABT/gwEBAQRIYXNoAf+EAAEGAUAAABn/hQEBAQlbMzJddWludDgB/4YAAQYBQAAAa/+CAiD/pv/jOjY1/9oC/4z/tHb/qf/2Jf+d/4H/u/+YGHj/+/+O/8D/v/+P/8X/qRL/5v/x/4r/tkIBIA1Y/8j/pR3/0P+b/7cwWP+W/87/sD18GP//Hf/f/9Aj//NcBFs2/9VhNEUF/70AAAAGIDlR1jVm5IfEJgvuSQoJLqLg4FcW4Ib1vW8sbkRHdUWX:651505fae9ea341c770c6ebef207d8560d546eb3aee26985e584c15d1c987875" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with macaroon without caveats returned status $status_code, expected 401"
            docker logs nginx-cln
            exit 1
          fi

          # Test protected route without header
          echo "Testing protected route without header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 60 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route without header returned status $status_code, expected 402"
            docker logs nginx-cln
            exit 1
          fi
          
          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response"
            echo "$response"
            docker logs nginx-cln
            exit 1
          fi

      - name: Stop CLN service
        run: |
          docker-compose -f docker-compose.yml stop nginx-cln

      - name: Verify LND node
        run: |
          identity_pubkey_lndnode=$(docker exec lndnode lncli -n regtest getinfo | jq -r '.identity_pubkey')
          echo "Pubkey: $identity_pubkey_lndnode"
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass -generate 5

          # Get node info for both lightning nodes
          echo "Getting CLN node info..."
          cln_pubkey=$(docker exec cln lightning-cli --network=regtest getinfo | jq -r '.id')
          echo "CLN pubkey: $cln_pubkey"

          echo "Getting LND node info..."
          lnd_pubkey=$(docker exec lndnode lncli -n regtest getinfo | jq -r '.identity_pubkey')
          echo "LND pubkey: $lnd_pubkey"

          # Generate a new address for LND node
          address=$(docker exec lndnode lncli -n regtest newaddress p2wkh | jq -r '.address')
          echo "Generated address for LND: $address"

          # Send 10 BTC to LND node
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass sendtoaddress "$address" 10
          
          # Generate blocks to confirm the transaction
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass generatetoaddress 6 "$address"

          # Connect nodes
          echo "Connecting LND to CLN..."
          docker exec lndnode lncli -n regtest connect $cln_pubkey@cln:9835

          # Open channel from LND to CLN
          echo "Opening channel from LND to CLN..."
          docker exec lndnode lncli -n regtest openchannel $cln_pubkey 1000000

          # Generate blocks to confirm channel
          docker exec bitcoind bitcoin-cli -regtest -rpcuser=user -rpcpassword=pass generatetoaddress 6 "$address"

          echo "NWC_URI=$(docker exec cln lightning-cli --network=regtest nip47-create label=nwc-for-l402 budget_msat=0 | jq -r '.uri')" >> $GITHUB_ENV

      - name: Start NWC service
        run: |
          docker-compose -f docker-compose.yml up -d --no-deps nginx-nwc

      - name: Run Integration Tests - NWC
        run: |
          echo "Testing with NWC configuration..."
          sleep 20

          # Test free route
          echo "Testing free route..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Free route returned status $status_code, expected 200"
            docker logs nginx-nwc
            exit 1
          fi

          # Test protected route with timeout without header
          echo "Testing protected route with timeout without header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 60 -L http://0.0.0.0:8000/protected-timeout)
          status_code=$(echo "$response" | tail -n1)
          echo "status_code: $status_code"
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route without header returned status $status_code, expected 402"
            docker logs nginx-nwc
            exit 1
          fi
          
          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response"
            echo "$response"
            docker logs nginx-nwc
            exit 1
          fi

          # Extract invoice from header
          invoice=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'invoice="[^"]*"' | cut -d'"' -f2)
          if [ -z "$invoice" ]; then
            echo "Error: No invoice found in WWW-Authenticate header"
            echo "$response"
            docker logs nginx-nwc
            exit 1
          fi
          echo "invoice: $invoice"

          # Pay invoice using LND to get preimage
          echo "Paying invoice through LND..."
          payment_result=$(docker exec lndnode lncli -n regtest payinvoice -f $invoice 2>&1)
          echo "payment_result: $payment_result"
          
          # Wait a few seconds for payment to settle
          echo "Waiting for payment to settle..."
          sleep 5
          
          # Get payment result with preimage
          payment_result=$(docker exec lndnode lncli -n regtest listpayments | jq -r '.payments[-1]')
          payment_status=$(echo "$payment_result" | jq -r '.status')
          echo "payment_result: $payment_result"
          echo "payment_status: $payment_status"
          
          if [ "$payment_status" != "SUCCEEDED" ]; then
            echo "Error: Payment failed or timed out"
            docker logs nginx-nwc
            exit 1
          fi

          # Extract preimage from payment result
          preimage=$(echo "$payment_result" | jq -r '.payment_preimage')
          macaroon=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'macaroon="[^"]*"' | cut -d'"' -f2)

          # Wait for preimage to be registered in the system
          echo "Waiting for preimage registration..."
          sleep 5

          # Test with obtained preimage
          echo "Testing protected route with valid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 $macaroon:$preimage" http://0.0.0.0:8000/protected-timeout)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with valid preimage returned status $status_code, expected 200"
            docker logs nginx-nwc
            exit 1
          fi

          # Wait for macaroon to expire (10 seconds)
          echo "Waiting for macaroon to expire..."
          sleep 15

          # Test with expired macaroon
          echo "Testing protected route with expired macaroon..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 $macaroon:$preimage" http://0.0.0.0:8000/protected-timeout)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with expired macaroon returned status $status_code, expected 401"
            docker logs nginx-nwc
            exit 1
          fi

          # Test with invalid preimage
          echo "Testing with invalid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:fbe9ac25c04e14b10177514e2d57b0e39224e70277ac1a2cd23c28e58cd4ea35" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid preimage returned status $status_code, expected 401"
            docker logs nginx-nwc
            exit 1
          fi

          # Test with macaroon without caveats
          echo "Testing with macaroon without caveats..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 AgEETFNBVALmAUr/gQMBARJNYWNhcm9vbklkZW50aWZpZXIB/4IAAQMBB1ZlcnNpb24BBgABC1BheW1lbnRIYXNoAf+EAAEHVG9rZW5JZAH/hgAAABT/gwEBAQRIYXNoAf+EAAEGAUAAABn/hQEBAQlbMzJddWludDgB/4YAAQYBQAAAa/+CAiD/pv/jOjY1/9oC/4z/tHb/qf/2Jf+d/4H/u/+YGHj/+/+O/8D/v/+P/8X/qRL/5v/x/4r/tkIBIA1Y/8j/pR3/0P+b/7cwWP+W/87/sD18GP//Hf/f/9Aj//NcBFs2/9VhNEUF/70AAAAGIDlR1jVm5IfEJgvuSQoJLqLg4FcW4Ib1vW8sbkRHdUWX:651505fae9ea341c770c6ebef207d8560d546eb3aee26985e584c15d1c987875" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with macaroon without caveats returned status $status_code, expected 401"
            docker logs nginx-nwc
            exit 1
          fi

      - name: Stop NWC service and CLN node
        run: |
          docker-compose -f docker-compose.yml stop nginx-nwc cln

      - name: Start nginx containers for LND
        env:
          CURRENCY: USD
          AMOUNT: 0.01
        run: |
          # Start the remaining services
          docker-compose -f docker-compose.yml up -d --no-deps nginx-lnd redis

      - name: Run Integration Tests - LND
        run: |
          docker ps -a
          echo "Testing with LND configuration..."
          sleep 15

          # Test free route
          echo "Testing free route..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Free route returned status $status_code, expected 200"
            docker logs nginx-lnd
            exit 1
          fi

          # Test protected route without header
          echo "Testing protected route without header..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route without header returned status $status_code, expected 402"
            docker logs nginx-lnd
            exit 1
          fi
          
          # Check if WWW-Authenticate header is present
          if ! echo "$response" | grep -q 'WWW-Authenticate: L402 macaroon='; then
            echo "Error: WWW-Authenticate header is missing in the 402 response"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Extract and verify invoice amount
          invoice=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'invoice="[^"]*"' | cut -d'"' -f2)
          if [ -z "$invoice" ]; then
            echo "Error: No invoice found in WWW-Authenticate header"
            echo "$response"
            docker logs nginx-lnurl
            exit 1
          fi

          # Decode invoice and check amount
          decoded_amount=$(docker exec lndnode lncli -n regtest decodepayreq "$invoice" | jq -r '.num_msat')
          if [ "$decoded_amount" != "10000" ]; then
            echo "Error: Invoice amount is $decoded_amount msat, expected 10000 msat"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Test dynamic pricing by setting a new price in Redis
          echo "Setting dynamic price to 15000 msat..."
          docker exec redis redis-cli set /protected 15000

          # Test protected route to get new invoice with dynamic price
          echo "Testing protected route with dynamic price..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route with dynamic price returned status $status_code, expected 402"
            docker logs nginx-lnd
            exit 1
          fi

          # Extract and verify new invoice amount
          invoice=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'invoice="[^"]*"' | cut -d'"' -f2)
          if [ -z "$invoice" ]; then
            echo "Error: No invoice found in WWW-Authenticate header for dynamic price"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Decode invoice and check dynamic amount
          decoded_amount=$(docker exec lndnode lncli -n regtest decodepayreq "$invoice" | jq -r '.num_msat')
          if [ "$decoded_amount" != "15000" ]; then
            echo "Error: Dynamic invoice amount is $decoded_amount msat, expected 15000 msat"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Reset price back to default
          echo "Resetting price back to default..."
          docker exec redis redis-cli del /protected

          # Test protected route to verify reset price
          echo "Testing protected route with reset price..."
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 402 ]; then
            echo "Error: Protected route with reset price returned status $status_code, expected 402"
            docker logs nginx-lnd
            exit 1
          fi

          # Extract and verify reset invoice amount
          invoice=$(echo "$response" | grep -i "WWW-Authenticate: L402" | grep -o 'invoice="[^"]*"' | cut -d'"' -f2)
          if [ -z "$invoice" ]; then
            echo "Error: No invoice found in WWW-Authenticate header after reset"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Decode invoice and check reset amount
          decoded_amount=$(docker exec lndnode lncli -n regtest decodepayreq "$invoice" | jq -r '.num_msat')
          if [ "$decoded_amount" != "10000" ]; then
            echo "Error: Reset invoice amount is $decoded_amount msat, expected 10000 msat"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi

          # Test with valid L402 credentials
          echo "Testing with valid L402 credentials..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:e582fba50ca50a9a262cbb92fc38617ce0a2413ef1dd4c7062cbaef22b33a404" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with valid L402 returned status $status_code, expected 200"
            docker logs nginx-lnd
            exit 1
          fi

          # Test with invalid preimage
          echo "Testing with invalid preimage..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 MDAxMmxvY2F0aW9uIEw0MDIKMDAzMGlkZW50aWZpZXIgM460twjJAuVrQN-u5JPUZ0aKNWevybkbveRc2DeF2ZAKMDAyMWNpZCBSZXF1ZXN0UGF0aCA9IC9wcm90ZWN0ZWQKMDAyZnNpZ25hdHVyZSCwR6G2lDj1thda81BPwQuo73_shURzPf1XOwuejNLwVwo=:fbe9ac25c04e14b10177514e2d57b0e39224e70277ac1a2cd23c28e58cd4ea35" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid preimage returned status $status_code, expected 401"
            docker logs nginx-lnd
            exit 1
          fi

          # Test with macaroon without caveats
          echo "Testing with macaroon without caveats..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: L402 AgEETFNBVALmAUr/gQMBARJNYWNhcm9vbklkZW50aWZpZXIB/4IAAQMBB1ZlcnNpb24BBgABC1BheW1lbnRIYXNoAf+EAAEHVG9rZW5JZAH/hgAAABT/gwEBAQRIYXNoAf+EAAEGAUAAABn/hQEBAQlbMzJddWludDgB/4YAAQYBQAAAa/+CAiD/pv/jOjY1/9oC/4z/tHb/qf/2Jf+d/4H/u/+YGHj/+/+O/8D/v/+P/8X/qRL/5v/x/4r/tkIBIA1Y/8j/pR3/0P+b/7cwWP+W/87/sD18GP//Hf/f/9Aj//NcBFs2/9VhNEUF/70AAAAGIDlR1jVm5IfEJgvuSQoJLqLg4FcW4Ib1vW8sbkRHdUWX:651505fae9ea341c770c6ebef207d8560d546eb3aee26985e584c15d1c987875" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with macaroon without caveats returned status $status_code, expected 401"
            docker logs nginx-lnd
            exit 1
          fi

          # Test Cashu eCash support
          echo "Testing Cashu eCash support..."

          # Ensure the Cashu database has proper permissions
          echo "Setting up Cashu database permissions..."
          docker exec nginx-lnd chmod 770 /app/data
          docker exec nginx-lnd chmod 660 /app/data/cashu_tokens.db
          echo "Cashu database permissions set successfully"
          
          # Check mint logs
          docker logs cashu-mint
          
          # Execute cashu commands inside the mint container using poetry run
          echo "Executing cashu commands inside the mint container..."
          
          # Check wallet info
          echo "Checking wallet info..."
          docker exec cashu-mint poetry run cashu info
          
          # Check initial balance
          echo "Checking initial balance..."
          docker exec cashu-mint poetry run cashu balance
          
          # Check balance after minting
          echo "Checking balance after minting..."
          docker exec cashu-mint poetry run cashu balance
          
          # Get token from wallet
          echo "Retrieving token from wallet..."
          CASHU_TOKEN=$(docker exec cashu-mint poetry run cashu send 10)
          
          echo "Cashu token: $CASHU_TOKEN"

          sleep 5
          
          # Test protected route with Cashu token
          echo "Testing protected route with Cashu token..."
          max_retries=3
          retry_count=0
          status_code=0
          
          while [ $retry_count -lt $max_retries ] && [ "$status_code" -ne 200 ]; do
            echo "Attempt $(($retry_count + 1)) of $max_retries..."
            response=$(curl -v -s -i -w "\n%{http_code}" --max-time 60 -L -H "Authorization: Cashu $CASHU_TOKEN" http://0.0.0.0:8000/protected)
            status_code=$(echo "$response" | tail -n1)
            
            if [ "$status_code" -ne 200 ]; then
              if echo "$response" | grep -q "401 Unauthorized"; then
                echo "Pool connection timed out, retrying..."
                sleep 5
                retry_count=$((retry_count + 1))
              else
                break
              fi
            fi
          done
          
          # The token should be accepted if the verification logic is working
          if [ "$status_code" -ne 200 ]; then
            echo "Error: Protected route with Cashu token returned unexpected status $status_code"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi
          
          # Test with invalid Cashu token (insufficient amount)
          echo "Testing with invalid Cashu token (insufficient amount)..."
          
          INVALID_CASHU_TOKEN=$(docker exec cashu-mint poetry run cashu send 1)

          sleep 5
          
          # Test with the invalid token
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $INVALID_CASHU_TOKEN" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          
          # This should fail verification due to insufficient amount
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with invalid Cashu token returned status $status_code, expected 401"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi
          
          # Test with malformed Cashu token
          echo "Testing with malformed Cashu token..."
          
          # Create a malformed token
          MALFORMED_CASHU_TOKEN='{
            "token": [
              {
                "mint": "http://cashu-mint:3338",
                "proofs": []
              }
            ]
          }'
          
          # Encode the malformed token
          ENCODED_MALFORMED_TOKEN=$(echo -n "$MALFORMED_CASHU_TOKEN" | base64 -w 0)

          sleep 5
          
          # Test with the malformed token
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $ENCODED_MALFORMED_TOKEN" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          
          # This should fail verification due to empty proofs
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with malformed Cashu token returned status $status_code, expected 401"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi
          
          # Test whitelisted mints functionality
          echo "Testing whitelisted mints functionality..."
          
          # Test with token from non-whitelisted mint
          echo "Testing with token from non-whitelisted mint (https://nofees.testnut.cashu.space)..."
          
          # Create a token with a non-whitelisted mint URL
          NON_WHITELISTED_TOKEN='{
            "token": [
              {
                "mint": "https://nofees.testnut.cashu.space",
                "proofs": [
                  {
                    "id": "test-proof",
                    "amount": 10,
                    "secret": "test-secret",
                    "C": "test-commitment"
                  }
                ]
              }
            ]
          }'
          
          # Encode the non-whitelisted token
          ENCODED_NON_WHITELISTED_TOKEN=$(echo -n "$NON_WHITELISTED_TOKEN" | base64 -w 0)

          sleep 5
          
          # Test with the non-whitelisted token
          response=$(curl -s -i -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $ENCODED_NON_WHITELISTED_TOKEN" http://0.0.0.0:8000/protected)
          status_code=$(echo "$response" | tail -n1)
          
          # This should fail verification due to non-whitelisted mint
          if [ "$status_code" -ne 401 ]; then
            echo "Error: Protected route with non-whitelisted Cashu token returned status $status_code, expected 401"
            echo "$response"
            docker logs nginx-lnd
            exit 1
          fi
          
          echo "âœ… Non-whitelisted mint token (https://nofees.testnut.cashu.space) correctly rejected!"
          
          echo "All Cashu eCash tests completed successfully!"
          docker logs nginx-lnd

      - name: Run Integration test - Cashu redemption on Lightning
        run: |
          # Capture initial channel balance (not wallet balance, since Lightning payments affect channels)
          INITIAL_RECEIVER_CHANNEL=$(docker exec lndnode-receiver lncli --rpcserver=127.0.0.1:10010 -n regtest channelbalance)
          echo "Initial LND-receiver Channel Balance: $INITIAL_RECEIVER_CHANNEL"

          INITIAL_RECEIVER_LOCAL_BALANCE=$(echo $INITIAL_RECEIVER_CHANNEL | jq -r '.local_balance.sat')
          echo "Initial LND-receiver Local Balance: $INITIAL_RECEIVER_LOCAL_BALANCE sats"

          INITIAL_LND_CHANNEL=$(docker exec lndnode lncli -n regtest channelbalance)
          echo "Initial LND Channel Balance: $INITIAL_LND_CHANNEL"

          INITIAL_LND_LOCAL_BALANCE=$(echo $INITIAL_LND_CHANNEL | jq -r '.local_balance.sat')
          echo "Initial LND Local Balance: $INITIAL_LND_LOCAL_BALANCE sats"

          echo "initial channel balance: lndnode"
          docker exec lndnode lncli -n regtest channelbalance

          echo "initial channel balance: lndnode-receiver"
          docker exec lndnode-receiver lncli -n regtest --rpcserver=127.0.0.1:10010 channelbalance

          echo "initial channels info: lndnode"
          docker exec lndnode lncli -n regtest listchannels

          echo "initial channels info: lndnode-receiver"
          docker exec lndnode-receiver lncli -n regtest --rpcserver=127.0.0.1:10010 listchannels

          echo "Cashu current balance"
          docker exec cashu-mint poetry run cashu balance

          echo "Running Cashu redemption on Lightning test..."
          cashu_token=$(docker exec cashu-mint poetry run cashu send 100)
          echo "Cashu Token of amount 100: $cashu_token"

          # access protected nginx-lnd route with cashu token
          response=$(curl -s -w "\n%{http_code}" --max-time 60 -L -H "Authorization: Cashu $cashu_token" http://0.0.0.0:8000/protected)

          if [ "$(echo "$response" | tail -n1)" -ne 200 ]; then
            echo "Error: unable to access protected route with Cashu token with response $(echo "$response" | tail -n1)"
            docker logs nginx-lnd
            exit 1
          fi

          echo "Cashu token consumed successfully to access protected route."

          REDEMPTION_INTERVAL=$(docker exec nginx-lnd env | grep CASHU_REDEMPTION_INTERVAL_SECS | cut -d'=' -f2 || echo "not_set")
          WAIT_TIME=$((REDEMPTION_INTERVAL + 30))

          echo "Waiting for $WAIT_TIME seconds to allow redemption process to complete..."
          sleep $WAIT_TIME

          # Capture final channel balance (Lightning payments affect channel balance, not wallet balance)
          FINAL_RECEIVER_CHANNEL=$(docker exec lndnode-receiver lncli --rpcserver=127.0.0.1:10010 -n regtest channelbalance)
          echo "FINAL LND-receiver Channel Balance: $FINAL_RECEIVER_CHANNEL"

          FINAL_RECEIVER_LOCAL_BALANCE=$(echo $FINAL_RECEIVER_CHANNEL | jq -r '.local_balance.sat')
          echo "FINAL LND-receiver Local Balance: $FINAL_RECEIVER_LOCAL_BALANCE sats"

          FINAL_LND_CHANNEL=$(docker exec lndnode lncli -n regtest channelbalance)
          echo "FINAL LND Channel Balance: $FINAL_LND_CHANNEL"

          FINAL_LND_LOCAL_BALANCE=$(echo $FINAL_LND_CHANNEL | jq -r '.local_balance.sat')
          echo "FINAL LND Local Balance: $FINAL_LND_LOCAL_BALANCE sats"

          BALANCE_RECEIVER_DIFFERENCE=$((FINAL_RECEIVER_LOCAL_BALANCE - INITIAL_RECEIVER_LOCAL_BALANCE))
          echo "Channel Balance RECEIVER Difference: $BALANCE_RECEIVER_DIFFERENCE sats"

          BALANCE_LND_DIFFERENCE=$((FINAL_LND_LOCAL_BALANCE - INITIAL_LND_LOCAL_BALANCE))
          echo "Channel Balance Difference (LND): $BALANCE_LND_DIFFERENCE sats"

          echo "final channel balance: lndnode"
          docker exec lndnode lncli -n regtest channelbalance

          echo "final channel balance: lndnode-receiver"
          docker exec lndnode-receiver lncli -n regtest --rpcserver=127.0.0.1:10010 channelbalance

          echo "final channels info: lndnode"
          docker exec lndnode lncli -n regtest listchannels

          echo "final channels info: lndnode-receiver"
          docker exec lndnode-receiver lncli -n regtest --rpcserver=127.0.0.1:10010 listchannels

          echo "invoices by lnd node"
          docker exec lndnode lncli -n regtest listinvoices | tail -20

          echo "invoices by lnd-receiver node"
          docker exec lndnode-receiver lncli -n regtest --rpcserver=127.0.0.1:10010 listinvoices | tail -20

          if [ "$BALANCE_RECEIVER_DIFFERENCE" -gt 0 ]; then
            echo "âœ… LND-receiver channel balance increased by $BALANCE_RECEIVER_DIFFERENCE sats from Cashu token redemption"
          else
            echo "âŒ No redemption activity detected - channel balance did not increase"

            echo "Payments by lnd node"
            docker exec lndnode lncli -n regtest listpayments

            echo "Payments by lnd-receiver node"
            docker exec lndnode-receiver lncli -n regtest --rpcserver=127.0.0.1:10010 listpayments

            echo "========== NGINX-LND LOGS BEGIN ==============="
            docker logs nginx-lnd
            echo "============ NGINX-LND LOGS END ================"

            echo "========== CASHU MINT LOGS BEGIN ==============="
            docker logs cashu-mint
            echo "============ CASHU MINT LOGS END ================"

            exit 1
          fi

          echo "âœ… Cashu redemption on Lightning integration tests completed!"

      - name: Run Integration Tests - Multi-tenant LNURL Cashu Redemption
        run: |
          echo "ðŸ¢ Testing Multi-tenant LNURL Cashu Redemption with 2 tenants..."

          docker-compose -f docker-compose.yml stop nginx-lnd
          sleep 5

          # Build and start lnurl-server for local LNURL address resolution
          echo "Building and starting lnurl-server..."
          docker-compose -f docker-compose.yml build lnurl-server
          docker-compose -f docker-compose.yml up -d lnurl-server
          sleep 10

          # Verify lnurl-server is running
          echo "Checking lnurl-server health..."
          docker logs lnurl-server 2>&1 | tail -10

          # Stop nginx-lnd and start nginx-lnurl with LNURL mode
          echo "Stopping nginx-lnd and starting nginx-lnurl for multi-tenant LNURL mode..."
          docker-compose -f docker-compose.yml up -d nginx-lnurl
          sleep 15

          # Flush Redis for clean test
          echo "Setting up Redis for multi-tenant testing..."
          docker exec redis redis-cli flushall

          # ========== CAPTURE INITIAL LND CHANNEL BALANCES ==========
          echo "Capturing initial LND channel balances before multi-tenant redemption..."
          
          INITIAL_RECEIVER_CHANNEL=$(docker exec lndnode-receiver lncli --rpcserver=127.0.0.1:10010 -n regtest channelbalance)
          echo "Initial LND-receiver Channel Balance: $INITIAL_RECEIVER_CHANNEL"
          INITIAL_RECEIVER_LOCAL_BALANCE=$(echo $INITIAL_RECEIVER_CHANNEL | jq -r '.local_balance.sat')
          echo "Initial LND-receiver Local Balance: $INITIAL_RECEIVER_LOCAL_BALANCE sats"

          INITIAL_LND_CHANNEL=$(docker exec lndnode lncli -n regtest channelbalance)
          echo "Initial LND Channel Balance: $INITIAL_LND_CHANNEL"
          INITIAL_LND_LOCAL_BALANCE=$(echo $INITIAL_LND_CHANNEL | jq -r '.local_balance.sat')
          echo "Initial LND Local Balance: $INITIAL_LND_LOCAL_BALANCE sats"

          # Create Cashu tokens for 2 tenants
          echo "Creating Cashu tokens for 2-tenant multi-tenant redemption..."

          # Create token 1 for tenant1 (amount: 50 sats) - maps to user1@lnurl-server (nginx.conf)
          TOKEN1=$(docker exec cashu-mint poetry run cashu send 50)
          echo "Token1 for tenant1 (50 sats): $TOKEN1"

          # Create token 2 for tenant2 (amount: 30 sats) - maps to user2@lnurl-server (nginx.conf)
          TOKEN2=$(docker exec cashu-mint poetry run cashu send 30)
          echo "Token2 for tenant2 (30 sats): $TOKEN2"

          sleep 5

          # ========== TEST ACCESSING TENANT-SPECIFIC ROUTES ==========
          echo "Testing multi-tenant token redemption with 2 different LNURL addresses..."

          # Access tenant1 route - should map to user1@lnurl-server (from nginx.conf)
          echo "Accessing tenant1 route (user1@lnurl-server)..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $TOKEN1" http://0.0.0.0:8000/tenant1)
          if [ "$(echo "$response" | tail -n1)" -ne 200 ]; then
            echo "Error: Failed to access tenant1 route with Token1"
            docker logs nginx-lnurl | tail -50
            exit 1
          fi
          echo "âœ… Token1 accepted and mapped to tenant1 (user1@lnurl-server)"

          # Access tenant2 route - should map to user2@lnurl-server (from nginx.conf)
          echo "Accessing tenant2 route (user2@lnurl-server)..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $TOKEN2" http://0.0.0.0:8000/tenant2)
          if [ "$(echo "$response" | tail -n1)" -ne 200 ]; then
            echo "Error: Failed to access tenant2 route with Token2"
            docker logs nginx-lnurl | tail -50
            exit 1
          fi
          echo "âœ… Token2 accepted and mapped to tenant2 (user2@lnurl-server)"

          # ========== VERIFY REDIS PROOF-TO-LNURL MAPPINGS ==========
          echo "Checking Redis for proof-to-lnurl mappings..."
          sleep 2
          REDIS_KEYS=$(docker exec redis redis-cli keys "cashu:proof_lnurl:*" 2>/dev/null | wc -l)
          echo "Found $REDIS_KEYS proof-to-lnurl mappings in Redis"

          if [ "$REDIS_KEYS" -gt 0 ]; then
            echo "âœ… Multi-tenant proof mappings created in Redis"

            # Check mappings for each tenant
            echo "Checking mappings per tenant..."
            TENANT1_COUNT=$(docker exec redis redis-cli keys "cashu:proof_lnurl:*" 2>/dev/null | xargs -I {} docker exec redis redis-cli get "{}" 2>/dev/null | grep "user1@lnurl-server" | wc -l)
            TENANT2_COUNT=$(docker exec redis redis-cli keys "cashu:proof_lnurl:*" 2>/dev/null | xargs -I {} docker exec redis redis-cli get "{}" 2>/dev/null | grep "user2@lnurl-server" | wc -l)

            echo "Tenant1 (user1@lnurl-server): $TENANT1_COUNT proofs"
            echo "Tenant2 (user2@lnurl-server): $TENANT2_COUNT proofs"
          else
            echo "âš ï¸ No proof-to-lnurl mappings found in Redis"
          fi

          # Create additional tokens for a second redemption cycle
          echo "Creating additional tokens for second redemption cycle..."
          TOKEN3=$(docker exec cashu-mint poetry run cashu send 40)
          echo "Token3 for tenant1 (40 sats): $TOKEN3"
          TOKEN4=$(docker exec cashu-mint poetry run cashu send 60)
          echo "Token4 for tenant2 (60 sats): $TOKEN4"

          sleep 5

          # Use additional tokens on tenant routes
          echo "Using additional tokens on tenant routes..."
          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $TOKEN3" http://0.0.0.0:8000/tenant1)
          if [ "$(echo "$response" | tail -n1)" -ne 200 ]; then
            echo "Error: Failed to access tenant1 route with Token3"
            exit 1
          fi

          response=$(curl -s -w "\n%{http_code}" --max-time 30 -L -H "Authorization: Cashu $TOKEN4" http://0.0.0.0:8000/tenant2)
          if [ "$(echo "$response" | tail -n1)" -ne 200 ]; then
            echo "Error: Failed to access tenant2 route with Token4"
            exit 1
          fi

          echo "âœ… All tokens accepted for 2-tenant multi-tenant redemption"

          # ========== WAIT FOR REDEMPTION CYCLES ==========
          REDEMPTION_INTERVAL=$(docker exec nginx-lnurl env | grep CASHU_REDEMPTION_INTERVAL_SECS | cut -d'=' -f2 || echo "15")
          WAIT_TIME=$((REDEMPTION_INTERVAL + 30))
          echo "Waiting for $WAIT_TIME seconds to allow redemption process to complete..."
          sleep $WAIT_TIME

          # ========== VERIFY LIGHTNING WALLET BALANCE AFTER REDEMPTION ==========
          echo "Verifying Lightning wallet balance after multi-tenant Cashu redemption..."

          FINAL_RECEIVER_CHANNEL=$(docker exec lndnode-receiver lncli --rpcserver=127.0.0.1:10010 -n regtest channelbalance)
          echo "FINAL LND-receiver Channel Balance: $FINAL_RECEIVER_CHANNEL"
          FINAL_RECEIVER_LOCAL_BALANCE=$(echo $FINAL_RECEIVER_CHANNEL | jq -r '.local_balance.sat')
          echo "FINAL LND-receiver Local Balance: $FINAL_RECEIVER_LOCAL_BALANCE sats"

          FINAL_LND_CHANNEL=$(docker exec lndnode lncli -n regtest channelbalance)
          echo "FINAL LND Channel Balance: $FINAL_LND_CHANNEL"
          FINAL_LND_LOCAL_BALANCE=$(echo $FINAL_LND_CHANNEL | jq -r '.local_balance.sat')
          echo "FINAL LND Local Balance: $FINAL_LND_LOCAL_BALANCE sats"

          BALANCE_RECEIVER_DIFFERENCE=$((FINAL_RECEIVER_LOCAL_BALANCE - INITIAL_RECEIVER_LOCAL_BALANCE))
          echo "Channel Balance RECEIVER Difference: $BALANCE_RECEIVER_DIFFERENCE sats"

          BALANCE_LND_DIFFERENCE=$((FINAL_LND_LOCAL_BALANCE - INITIAL_LND_LOCAL_BALANCE))
          echo "Channel Balance Difference (LND): $BALANCE_LND_DIFFERENCE sats"

          # Check redemption logs for multi-tenant behavior
          echo "Checking redemption logs for multi-tenant activity..."
          docker logs nginx-lnurl 2>&1 | grep -i "multi-tenant\|grouped proofs\|lnurl\|redemption" | tail -20

          # Verify Redis has processed proofs for both tenants
          FINAL_REDIS_KEYS=$(docker exec redis redis-cli keys "cashu:proof_lnurl:*" 2>/dev/null | wc -l)
          echo "Total proof-to-lnurl mappings created: $FINAL_REDIS_KEYS"

          # Final verification of tenant separation
          echo "Final verification of 2-tenant separation in Redis..."
          if [ "$FINAL_REDIS_KEYS" -gt 0 ]; then
            UNIQUE_TENANTS=$(docker exec redis redis-cli keys "cashu:proof_lnurl:*" 2>/dev/null | xargs -I {} docker exec redis redis-cli get "{}" 2>/dev/null | sort | uniq | wc -l)
            echo "Number of unique tenants with proofs: $UNIQUE_TENANTS"

            if [ "$UNIQUE_TENANTS" -ge 2 ]; then
              echo "âœ… Multi-tenant separation verified: proofs mapped to 2 different LNURL addresses"
            else
              echo "âš ï¸ Expected 2 unique tenants but found $UNIQUE_TENANTS"
            fi
          fi

          # Verify Lightning wallet balance increased (redemption success criterion)
          if [ "$BALANCE_RECEIVER_DIFFERENCE" -gt 0 ]; then
            echo "âœ… LND-receiver channel balance increased by $BALANCE_RECEIVER_DIFFERENCE sats from multi-tenant Cashu token redemption via LNURL"
          else
            echo "âŒ No balance increase detected - multi-tenant LNURL redemption may have failed"
            docker logs lnurl-server | tail -30
            docker logs nginx-lnurl | tail -50
            exit 1
          fi

          # Print payment history for debugging
          echo "LND node payments:"
          docker exec lndnode lncli -n regtest listpayments | tail -20

          echo "LND-receiver node invoices:"
          docker exec lndnode-receiver lncli -n regtest --rpcserver=127.0.0.1:10010 listinvoices | tail -20

          echo "========== LNURL-SERVER LOGS =========="
          docker logs lnurl-server | tail -30

          echo "========== NGINX-LNURL LOGS =========="
          docker logs nginx-lnurl | tail -50

          echo "âœ… Multi-tenant LNURL Cashu Redemption integration test completed with 2 tenants!"

      - name: Publish .so file
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          tar -czf ngx_l402-${VERSION}.tar.gz target/release/libngx_l402_lib.so
          gh release create ${GITHUB_REF#refs/tags/} ngx_l402-${VERSION}.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}